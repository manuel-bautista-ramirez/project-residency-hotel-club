<style>
/* Estilos personalizados para el panel de administraci√≥n */
.admin-card {
  transition: all 0.3s ease;
  border-left: 4px solid transparent;
}

.admin-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.admin-card.total { border-left-color: #3b82f6; }
.admin-card.admins { border-left-color: #10b981; }
.admin-card.users { border-left-color: #f59e0b; }
.admin-card.active { border-left-color: #8b5cf6; }

.stats-icon {
  transition: transform 0.3s ease;
}

.admin-card:hover .stats-icon {
  transform: scale(1.1);
}

.user-table {
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.user-row {
  transition: background-color 0.2s ease;
}

.user-row:hover {
  background-color: #f8fafc;
}

.action-btn {
  transition: all 0.2s ease;
  padding: 8px;
  border-radius: 6px;
}

.action-btn:hover {
  transform: scale(1.1);
}

.edit-btn:hover {
  background-color: #dbeafe;
}

.delete-btn:hover {
  background-color: #fee2e2;
}

.create-btn {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  transition: all 0.3s ease;
}

.create-btn:hover {
  background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.modal-overlay {
  backdrop-filter: blur(4px);
  animation: fadeIn 0.3s ease;
}

.modal-content {
  animation: slideIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { 
    opacity: 0; 
    transform: translateY(-20px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

.role-badge {
  transition: all 0.2s ease;
}

.role-badge:hover {
  transform: scale(1.05);
}

.admin-badge {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.user-badge {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
}

.form-input {
  transition: all 0.3s ease;
}

.form-input:focus {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.header-gradient {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stats-container {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Efectos adicionales */
.pulse-effect {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.loading-spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #3b82f6;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Asegurar espacio para la barra de navegaci√≥n */
body {
  padding-top: 0 !important;
}

.admin-container {
  min-height: calc(100vh - 60px);
  margin-top: 0;
  padding-bottom: 4rem !important;
}

.user-table {
  margin-bottom: 3rem;
}

/* Asegurar que el contenido no se corte por el footer */
main, .main-content {
  padding-bottom: 5rem !important;
}

/* Estilo espec√≠fico para la tabla responsive */
.table-container {
  margin-bottom: 4rem;
}

.table-wrapper {
  max-height: calc(100vh - 400px);
  overflow-y: auto;
  border-radius: 12px;
}

/* Scroll personalizado para la tabla */
.table-wrapper::-webkit-scrollbar {
  width: 8px;
}

.table-wrapper::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 4px;
}

.table-wrapper::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

.table-wrapper::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Ajuste din√°mico basado en n√∫mero de usuarios */
.table-auto-height {
  max-height: none;
  overflow: visible;
}

/* Header fijo de la tabla */
.table-header-fixed {
  position: sticky;
  top: 0;
  z-index: 10;
  background: linear-gradient(to right, #f8fafc, #e2e8f0);
}

/* Responsive improvements */
@media (max-width: 768px) {
  .stats-container {
    padding: 1rem;
  }
  
  .admin-card {
    padding: 1rem;
  }
  
  .modal-content {
    margin: 1rem;
    max-width: calc(100vw - 2rem);
  }
  
  .create-btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }
  
  /* M√°s espacio en m√≥viles */
  .admin-container {
    padding-top: 6rem !important;
    padding-bottom: 6rem !important;
  }
  
  .table-container {
    margin-bottom: 5rem;
  }
}

/* Mejoras de accesibilidad */
.action-btn:focus,
.create-btn:focus,
.form-input:focus {
  outline: 2px solid #3b82f6;
  outline-offset: 2px;
}

/* Estado de carga */
.btn-loading {
  position: relative;
  color: transparent;
}

.btn-loading::after {
  content: "";
  position: absolute;
  width: 16px;
  height: 16px;
  top: 50%;
  left: 50%;
  margin-left: -8px;
  margin-top: -8px;
  border: 2px solid #ffffff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

/* Notificaciones toast */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #10b981;
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  animation: slideInRight 0.3s ease;
}

.toast.error {
  background: #ef4444;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
</style>

<div class="container mx-auto px-4 pt-20 pb-16 admin-container">
  <!-- Header del Panel -->
  <div class="mb-8 text-center">
    <h1 class="text-4xl font-bold header-gradient mb-3">Panel de Administraci√≥n</h1>
    <p class="text-lg text-gray-600">Gestiona usuarios y configuraciones del sistema</p>
  </div>

  <!-- Estad√≠sticas -->
  <div class="stats-container">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="bg-white rounded-lg shadow-lg p-6 admin-card total">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-blue-100 text-blue-600 stats-icon">
            <i class="fas fa-users text-xl"></i>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Usuarios</h3>
            <p class="text-3xl font-bold text-gray-900">{{stats.total}}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-6 admin-card admins">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-green-100 text-green-600 stats-icon">
            <i class="fas fa-user-shield text-xl"></i>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Administradores</h3>
            <p class="text-3xl font-bold text-gray-900">{{stats.administrators}}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-6 admin-card users">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 stats-icon">
            <i class="fas fa-user text-xl"></i>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Usuarios Regulares</h3>
            <p class="text-3xl font-bold text-gray-900">{{stats.regularUsers}}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-6 admin-card active">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-purple-100 text-purple-600 stats-icon">
            <i class="fas fa-chart-line text-xl"></i>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Activos (30 d√≠as)</h3>
            <p class="text-3xl font-bold text-gray-900">{{stats.recentlyActive}}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gesti√≥n de Usuarios -->
  <div class="bg-white user-table table-container">
    <div class="px-6 py-5 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-gray-50 to-gray-100">
      <h2 class="text-xl font-bold text-gray-900">Gesti√≥n de Usuarios</h2>
      <button 
        onclick="showCreateUserModal()" 
        class="create-btn text-white px-6 py-3 rounded-lg text-sm font-medium flex items-center shadow-lg">
        <i class="fas fa-plus mr-2"></i>
        Crear Usuario
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">ID</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Usuario</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Rol</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {{#each users}}
          <tr class="user-row">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{{this.id}}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center shadow-md">
                    <i class="fas fa-user text-white text-sm"></i>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-bold text-gray-900">{{this.username}}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {{#if (eq this.role 'Administrador')}}
                <span class="role-badge admin-badge inline-flex px-3 py-1 text-xs font-bold rounded-full text-white">
                  <i class="fas fa-shield-alt mr-1"></i>
                  Administrador
                </span>
              {{else}}
                <span class="role-badge user-badge inline-flex px-3 py-1 text-xs font-bold rounded-full text-white">
                  <i class="fas fa-user mr-1"></i>
                  Usuario
                </span>
              {{/if}}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
              <button 
                onclick="editUser({{this.id}})" 
                class="action-btn edit-btn text-blue-600 hover:text-blue-900"
                title="Editar usuario">
                <i class="fas fa-edit text-lg"></i>
              </button>
              <button 
                onclick="deleteUser({{this.id}}, '{{this.username}}')" 
                class="action-btn delete-btn text-red-600 hover:text-red-900"
                title="Eliminar usuario">
                <i class="fas fa-trash text-lg"></i>
              </button>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para Crear/Editar Usuario -->
<div id="userModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50 modal-overlay">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full modal-content">
      <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-xl">
        <h3 id="modalTitle" class="text-xl font-bold text-gray-900">Crear Usuario</h3>
        <p class="text-sm text-gray-600 mt-1">Complete la informaci√≥n del usuario</p>
      </div>
      
      <form id="userForm" class="px-6 py-6">
        <input type="hidden" id="userId" name="userId">
        
        <div class="mb-5">
          <label for="username" class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-user mr-2 text-blue-500"></i>
            Nombre de Usuario
          </label>
          <input 
            type="text" 
            id="username" 
            name="username" 
            required
            class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
        </div>

        <div class="mb-5">
          <label for="password" class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-lock mr-2 text-blue-500"></i>
            Contrase√±a
          </label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
          <p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded">
            <i class="fas fa-info-circle mr-1"></i>
            M√≠nimo 6 caracteres. D√©jalo vac√≠o para mantener la contrase√±a actual al editar.
          </p>
        </div>

        <div class="mb-6">
          <label for="role" class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-user-tag mr-2 text-blue-500"></i>
            Rol
          </label>
          <select 
            id="role" 
            name="role" 
            required
            class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
            <option value="">Selecciona un rol</option>
            <option value="Administrador">üõ°Ô∏è Administrador</option>
            <option value="Usuario">üë§ Usuario</option>
          </select>
        </div>

        <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
          <button 
            type="button" 
            onclick="closeUserModal()" 
            class="px-6 py-3 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all">
            <i class="fas fa-times mr-2"></i>
            Cancelar
          </button>
          <button 
            type="submit" 
            class="create-btn px-6 py-3 text-sm font-medium text-white rounded-lg shadow-lg">
            <i class="fas fa-save mr-2"></i>
            <span id="submitButtonText">Crear Usuario</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let isEditing = false;

// Funci√≥n global para manejar respuestas de usuario eliminado
function handleUserDeletedResponse(response, data) {
  if (response.status === 401 && (data?.userDeleted || data?.adminRevoked)) {
    alert(data.message || 'Tu cuenta ha sido eliminada. Ser√°s redirigido al login.');
    window.location.href = '/login';
    return true;
  }
  return false;
}

// Interceptar todas las peticiones fetch para manejar usuarios eliminados
const originalFetch = window.fetch;
window.fetch = async function(...args) {
  try {
    const response = await originalFetch.apply(this, args);
    
    // Si es una respuesta JSON, verificar si el usuario fue eliminado
    if (response.headers.get('content-type')?.includes('application/json')) {
      const clonedResponse = response.clone();
      try {
        const data = await clonedResponse.json();
        if (handleUserDeletedResponse(response, data)) {
          return response; // Detener el procesamiento
        }
      } catch (e) {
        // No es JSON v√°lido, continuar normalmente
      }
    }
    
    return response;
  } catch (error) {
    throw error;
  }
};

// Funci√≥n para mostrar notificaciones toast
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type === 'error' ? 'error' : ''}`;
  toast.innerHTML = `
    <div class="flex items-center">
      <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} mr-2"></i>
      ${message}
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease forwards';
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 3000);
}

// Funci√≥n para mostrar estado de carga en botones
function setButtonLoading(button, loading = true) {
  if (loading) {
    button.classList.add('btn-loading');
    button.disabled = true;
  } else {
    button.classList.remove('btn-loading');
    button.disabled = false;
  }
}

function showCreateUserModal() {
  isEditing = false;
  document.getElementById('modalTitle').textContent = 'Crear Usuario';
  document.getElementById('submitButtonText').textContent = 'Crear Usuario';
  document.getElementById('userForm').reset();
  document.getElementById('userId').value = '';
  document.getElementById('password').required = true;
  document.getElementById('userModal').classList.remove('hidden');
  
  // Enfocar el primer campo
  setTimeout(() => {
    document.getElementById('username').focus();
  }, 100);
}

function closeUserModal() {
  document.getElementById('userModal').classList.add('hidden');
}

async function editUser(userId) {
  try {
    const response = await fetch(`/api/admin/users/${userId}`);
    const data = await response.json();
    
    if (data.success) {
      isEditing = true;
      document.getElementById('modalTitle').textContent = 'Editar Usuario';
      document.getElementById('submitButtonText').textContent = 'Actualizar Usuario';
      document.getElementById('userId').value = data.user.id;
      document.getElementById('username').value = data.user.username;
      document.getElementById('role').value = data.user.role;
      document.getElementById('password').value = '';
      document.getElementById('password').required = false;
      document.getElementById('userModal').classList.remove('hidden');
    } else {
      alert('Error al cargar los datos del usuario');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error al cargar los datos del usuario');
  }
}

async function deleteUser(userId, username) {
  // Crear modal de confirmaci√≥n personalizado
  const confirmModal = document.createElement('div');
  confirmModal.className = 'fixed inset-0 bg-gray-900 bg-opacity-60 z-50 modal-overlay';
  confirmModal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full modal-content">
        <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-red-50 to-pink-50 rounded-t-xl">
          <h3 class="text-xl font-bold text-gray-900">
            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
            Confirmar Eliminaci√≥n
          </h3>
        </div>
        <div class="px-6 py-4">
          <p class="text-gray-700 mb-4">
            ¬øEst√°s seguro de que quieres eliminar al usuario <strong>"${username}"</strong>?
          </p>
          <p class="text-sm text-red-600 bg-red-50 p-3 rounded">
            <i class="fas fa-info-circle mr-1"></i>
            Esta acci√≥n no se puede deshacer.
          </p>
        </div>
        <div class="flex justify-end space-x-4 px-6 py-4 border-t border-gray-200">
          <button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all">
            <i class="fas fa-times mr-2"></i>Cancelar
          </button>
          <button onclick="confirmDelete(${userId})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all">
            <i class="fas fa-trash mr-2"></i>Eliminar
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(confirmModal);
  
  window.closeConfirmModal = () => {
    document.body.removeChild(confirmModal);
  };
  
  window.confirmDelete = async (id) => {
    const deleteBtn = confirmModal.querySelector('button[onclick*="confirmDelete"]');
    setButtonLoading(deleteBtn, true);
    
    try {
      const response = await fetch(`/api/admin/users/${id}`, {
        method: 'DELETE'
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast('Usuario eliminado exitosamente', 'success');
        closeConfirmModal();
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(data.message || 'Error al eliminar el usuario', 'error');
        setButtonLoading(deleteBtn, false);
      }
    } catch (error) {
      console.error('Error:', error);
      if (error.status === 401) {
        showToast('Tu cuenta ha sido eliminada. Ser√°s redirigido al login.', 'error');
        setTimeout(() => window.location.href = '/login', 2000);
      } else {
        showToast('Error al eliminar el usuario', 'error');
        setButtonLoading(deleteBtn, false);
      }
    }
  };
}

document.getElementById('userForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const submitBtn = this.querySelector('button[type="submit"]');
  setButtonLoading(submitBtn, true);
  
  const formData = new FormData(this);
  const userData = {
    username: formData.get('username'),
    password: formData.get('password'),
    role: formData.get('role')
  };
  
  try {
    let response;
    
    if (isEditing) {
      const userId = formData.get('userId');
      response = await fetch(`/api/admin/users/${userId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
      });
    } else {
      response = await fetch('/api/admin/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
      });
    }
    
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message || (isEditing ? 'Usuario actualizado exitosamente' : 'Usuario creado exitosamente'), 'success');
      closeUserModal();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message || 'Error al procesar la solicitud', 'error');
      setButtonLoading(submitBtn, false);
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('Error al procesar la solicitud', 'error');
    setButtonLoading(submitBtn, false);
  }
});

// Cerrar modal al hacer clic fuera de √©l
document.getElementById('userModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeUserModal();
  }
});
</script>