{{!-- CDN References (commented out) --}}
{{!-- <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script> --}}
{{!-- <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"> --}}

{{!-- Local Files --}}
<link href="/js/ModuleRomms/lib/css/fullcalendar@6.1.8/css/index.global.min.css" rel="stylesheet">
<script src="/js/ModuleRomms/lib/fullcalendar@6.1.8/js/index.global.min.js"></script>

<!-- Layout compacto sin scroll -->
<div class="min-h-screen bg-gray-50 overflow-hidden">
  <div class="max-w-7xl mx-auto px-3 py-4">
    <!-- Encabezado compacto -->
    <div class="mb-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-gray-900">Calendario</h1>
      <button 
        onclick="refreshCalendar()" 
        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-md transition-colors flex items-center gap-2"
        title="Actualizar calendario"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Actualizar
      </button>
    </div>

    <!-- Estad铆sticas compactas -->
    <div class="grid grid-cols-3 gap-3 mb-4" id="stats-container">
      <div class="bg-white rounded-lg p-3 shadow-sm border text-center">
        <p class="text-gray-500 text-xs">EVENTOS</p>
        <p class="text-lg font-bold text-gray-900 mt-1" id="total-events">0</p>
      </div>
      
      <div class="bg-white rounded-lg p-3 shadow-sm border text-center">
        <p class="text-gray-500 text-xs">RENTAS</p>
        <p class="text-lg font-bold text-gray-900 mt-1" id="total-rentas">0</p>
      </div>
      
      <div class="bg-white rounded-lg p-3 shadow-sm border text-center">
        <p class="text-gray-500 text-xs">RESERVACIONES</p>
        <p class="text-lg font-bold text-gray-900 mt-1" id="total-reservaciones">0</p>
      </div>
    </div>

    <!-- Calendario compacto -->
    <div class="bg-white rounded-lg shadow p-3 border">
      <div id="calendar" class="w-full"></div>
    </div>
  </div>
</div>

<!-- Modal compacto -->
<div id="viewEventModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-black bg-opacity-50">
  <div class="flex items-center justify-center min-h-screen p-3">
    <div class="bg-white rounded-lg shadow-lg max-w-sm w-full mx-auto">
      <!-- Header compacto -->
      <div id="viewEventHeader" class="px-4 py-3 rounded-t-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div id="viewEventIcon" class="rounded-full p-2">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <h3 id="viewEventTitle" class="text-sm font-bold text-white truncate"></h3>
              <span id="viewEventBadge" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold mt-0.5"></span>
            </div>
          </div>
          <button onclick="closeViewEventModal()" class="text-white/80 hover:text-white transition-colors flex-shrink-0">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Contenido compacto -->
      <div class="px-4 py-3 space-y-3">
        <!-- Fechas -->
        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-md">
          <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Fechas</p>
            <p id="viewEventDates" class="text-sm font-bold text-gray-900 mt-0.5 truncate"></p>
          </div>
        </div>

        <!-- Correo -->
        <div id="viewEventEmailContainer" class="flex items-start gap-3 p-3 bg-gray-50 rounded-md">
          <div class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Correo</p>
            <p id="viewEventEmail" class="text-sm font-medium text-gray-900 mt-0.5 break-all"></p>
          </div>
        </div>

        <!-- Tel茅fono -->
        <div id="viewEventPhoneContainer" class="flex items-start gap-3 p-3 bg-gray-50 rounded-md">
          <div class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Tel茅fono</p>
            <p id="viewEventPhone" class="text-sm font-medium text-gray-900 mt-0.5"></p>
          </div>
        </div>
      </div>

      <!-- Footer compacto -->
      <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 rounded-b-lg">
        <button 
          onclick="closeViewEventModal()"
          class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md text-sm transition-colors"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function openViewEventModal(eventInfo) {
    const modal = document.getElementById('viewEventModal');
    const header = document.getElementById('viewEventHeader');
    const icon = document.getElementById('viewEventIcon');
    const badge = document.getElementById('viewEventBadge');
    
    const isRenta = eventInfo.extendedProps.tipo === 'renta';
    if (isRenta) {
      header.className = 'px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-t-lg';
      icon.className = 'rounded-full p-2 bg-emerald-500';
      badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold mt-0.5 bg-emerald-100 text-emerald-800';
      badge.innerHTML = ' Renta';
    } else {
      header.className = 'px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 rounded-t-lg';
      icon.className = 'rounded-full p-2 bg-blue-500';
      badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold mt-0.5 bg-blue-100 text-blue-800';
      badge.innerHTML = ' Reservaci贸n';
    }
    
    document.getElementById('viewEventTitle').textContent = eventInfo.title;
    
    const startDate = eventInfo.start.toLocaleDateString('es-MX', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
    const endDate = eventInfo.end ? eventInfo.end.toLocaleDateString('es-MX', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    }) : 'N/A';
    document.getElementById('viewEventDates').textContent = `${startDate} - ${endDate}`;
    
    const emailContainer = document.getElementById('viewEventEmailContainer');
    const email = eventInfo.extendedProps.correo;
    if (email) {
      document.getElementById('viewEventEmail').textContent = email;
      emailContainer.classList.remove('hidden');
    } else {
      emailContainer.classList.add('hidden');
    }
    
    const phoneContainer = document.getElementById('viewEventPhoneContainer');
    const phone = eventInfo.extendedProps.telefono;
    if (phone) {
      document.getElementById('viewEventPhone').textContent = phone;
      phoneContainer.classList.remove('hidden');
    } else {
      phoneContainer.classList.add('hidden');
    }
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeViewEventModal() {
    const modal = document.getElementById('viewEventModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const viewModal = document.getElementById('viewEventModal');
      if (!viewModal.classList.contains('hidden')) {
        closeViewEventModal();
      }
    }
  });

  document.addEventListener('DOMContentLoaded', async function() {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 'auto',
      aspectRatio: 1.2,
      locale: 'es',
      firstDay: 1,
      contentHeight: 'auto',
      expandRows: false,
      stickyHeaderDates: true,
      fixedWeekCount: false,
      dayMaxEvents: 2,
      eventDisplay: 'block',
      displayEventTime: false,
      moreLinkClick: 'week',
      handleWindowResize: true,
      headerToolbar: {
        left: 'prev,next',
        center: 'title',
        right: 'today'
      },
      buttonText: {
        today: 'Hoy'
      },
      eventClick: function(info) {
        info.jsEvent.preventDefault();
        info.jsEvent.stopPropagation();
        openViewEventModal(info.event);
      },
      eventDidMount: function(info) {
        if (info.event.extendedProps.tipo === 'renta') {
          info.el.classList.add('bg-emerald-500', 'text-white', 'text-xs', 'px-1', 'py-0.5', 'rounded', 'border', 'border-emerald-600');
        } else {
          info.el.classList.add('bg-blue-500', 'text-white', 'text-xs', 'px-1', 'py-0.5', 'rounded', 'border', 'border-blue-600');
        }
        
        info.el.style.cursor = 'pointer';
        info.el.title = `${info.event.title}`;
        
        info.el.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openViewEventModal(info.event);
        });
      },
      eventsSet: function(events) {
        const totalEvents = events.length;
        const rentas = events.filter(e => e.extendedProps?.tipo === 'renta').length;
        const reservaciones = events.filter(e => e.extendedProps?.tipo === 'reservacion').length;
        
        document.getElementById('total-events').textContent = totalEvents;
        document.getElementById('total-rentas').textContent = rentas;
        document.getElementById('total-reservaciones').textContent = reservaciones;
      },
      eventSources: [
        {
          url: '/rooms/calendario/eventos',
          failure: function(error) {
            console.error('Error cargando eventos:', error);
          }
        }
      ]
    });

    calendar.render();

    // Verificar si se viene de una actualizaci贸n y refrescar inmediatamente
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('updated') === 'true') {
      console.log(' Detectada actualizaci贸n, refrescando calendario...');
      setTimeout(function() {
        calendar.refetchEvents();
        // Limpiar el par谩metro de la URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
      }, 1000);
    }

    // Actualizaci贸n autom谩tica cada 30 segundos
    setInterval(function() {
      console.log(' Actualizando eventos del calendario...');
      calendar.refetchEvents();
    }, 30000);

    // Funci贸n global para actualizar manualmente el calendario
    window.refreshCalendar = function() {
      console.log(' Actualizando calendario manualmente...');
      calendar.refetchEvents();
    };

    // Prevenir scroll
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    window.addEventListener('resize', function() {
      calendar.updateSize();
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
    });
  });
</script>