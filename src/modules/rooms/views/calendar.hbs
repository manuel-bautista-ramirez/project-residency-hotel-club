<!-- Layout mejorado RESPONSIVE -->
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 pt-20 sm:p-4">
  <div class="max-w-7xl mx-auto overflow-x-hidden pb-16">
    <!-- Header mejorado -->
    <div class="mb-4 sm:mb-6 text-center px-2 pt-12">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-1 sm:mb-2">Calendario de Habitaciones</h1>
      <p class="text-sm sm:text-base text-gray-600">Gestiona tus reservas y rentas</p>
    </div>

    <!-- Estad칤sticas con mejor dise침o RESPONSIVE -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6 px-2">
      <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 text-center border-l-4 border-blue-500">
        <div class="text-xl sm:text-2xl font-bold text-blue-600 mb-1" id="total-events">0</div>
        <div class="text-xs sm:text-sm font-semibold text-gray-600 uppercase tracking-wide">Total Eventos</div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 text-center border-l-4 border-green-500">
        <div class="text-xl sm:text-2xl font-bold text-green-600 mb-1" id="total-rentas">0</div>
        <div class="text-xs sm:text-sm font-semibold text-gray-600 uppercase tracking-wide">Rentas Activas</div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 text-center border-l-4 border-purple-500 sm:col-span-2 lg:col-span-1">
        <div class="text-xl sm:text-2xl font-bold text-purple-600 mb-1" id="total-reservaciones">0</div>
        <div class="text-xs sm:text-sm font-semibold text-gray-600 uppercase tracking-wide">Reservaciones</div>
      </div>
    </div>

    <!-- Controles del calendario -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-4 mx-2">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <button
          onclick="refreshCalendar()"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-all duration-200 flex items-center gap-2 shadow-md hover:shadow-lg"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Actualizar Calendario
        </button>
        <div class="text-lg font-semibold text-gray-700" id="current-month">Noviembre 2025</div>
      </div>
    </div>

    <!-- Calendario con dise침o mejorado RESPONSIVE -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mx-2">
      <div id="calendar" class="w-full min-h-[600px]"></div>
    </div>
  </div>
</div>

<!-- Modal mejorado -->
<div id="viewEventModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-black bg-opacity-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-auto overflow-hidden">
      <!-- Header del modal -->
      <div id="viewEventHeader" class="px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div id="viewEventIcon" class="rounded-xl p-3">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <div>
              <h3 id="viewEventTitle" class="text-lg font-bold text-white"></h3>
              <span id="viewEventBadge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold mt-1"></span>
            </div>
          </div>
          <button onclick="closeViewEventModal()" class="text-white/80 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Contenido del modal -->
      <div class="px-6 py-4 space-y-4">
        <!-- Fechas -->
        <div class="flex items-center gap-4 p-3 bg-blue-50 rounded-xl">
          <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div>
            <p class="text-xs font-semibold text-blue-600 uppercase tracking-wide">Fechas</p>
            <p id="viewEventDates" class="text-base font-bold text-gray-900"></p>
          </div>
        </div>

        <!-- Correo -->
        <div id="viewEventEmailContainer" class="flex items-center gap-4 p-3 bg-purple-50 rounded-xl">
          <div class="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
          </div>
          <div>
            <p class="text-xs font-semibold text-purple-600 uppercase tracking-wide">Correo</p>
            <p id="viewEventEmail" class="text-sm font-medium text-gray-900 break-all"></p>
          </div>
        </div>

        <!-- Tel칠fono -->
        <div id="viewEventPhoneContainer" class="flex items-center gap-4 p-3 bg-green-50 rounded-xl">
          <div class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
          </div>
          <div>
            <p class="text-xs font-semibold text-green-600 uppercase tracking-wide">Tel칠fono</p>
            <p id="viewEventPhone" class="text-sm font-medium text-gray-900"></p>
          </div>
        </div>
      </div>

      <!-- Footer del modal -->
      <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
        <button
          onclick="closeViewEventModal()"
          class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl text-base transition-colors shadow-md hover:shadow-lg"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Funci칩n para abrir el modal de evento
  function openViewEventModal(eventInfo) {
    const modal = document.getElementById('viewEventModal');
    const header = document.getElementById('viewEventHeader');
    const icon = document.getElementById('viewEventIcon');
    const badge = document.getElementById('viewEventBadge');

    const isRenta = eventInfo.extendedProps.tipo === 'renta';
    if (isRenta) {
      header.className = 'px-6 py-4 bg-gradient-to-r from-emerald-600 to-emerald-700';
      icon.className = 'rounded-xl p-3 bg-emerald-500';
      badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold mt-1 bg-emerald-100 text-emerald-800';
      badge.innerHTML = '游 Renta Activa';
    } else {
      header.className = 'px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700';
      icon.className = 'rounded-xl p-3 bg-blue-500';
      badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold mt-1 bg-blue-100 text-blue-800';
      badge.innerHTML = '游늶 Reservaci칩n';
    }

    document.getElementById('viewEventTitle').textContent = eventInfo.title;

    const startDate = eventInfo.start.toLocaleDateString('es-MX', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    const endDate = eventInfo.end ? eventInfo.end.toLocaleDateString('es-MX', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }) : 'No especificada';

    document.getElementById('viewEventDates').textContent = `Del ${startDate} al ${endDate}`;

    const emailContainer = document.getElementById('viewEventEmailContainer');
    const email = eventInfo.extendedProps.correo;
    if (email) {
      document.getElementById('viewEventEmail').textContent = email;
      emailContainer.classList.remove('hidden');
    } else {
      emailContainer.classList.add('hidden');
    }

    const phoneContainer = document.getElementById('viewEventPhoneContainer');
    const phone = eventInfo.extendedProps.telefono;
    if (phone) {
      document.getElementById('viewEventPhone').textContent = phone;
      phoneContainer.classList.remove('hidden');
    } else {
      phoneContainer.classList.add('hidden');
    }

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  // Funci칩n para cerrar el modal
  function closeViewEventModal() {
    const modal = document.getElementById('viewEventModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  }

  // Cerrar modal con ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeViewEventModal();
    }
  });

  // Funci칩n para cargar eventos de ejemplo
  function loadSampleEvents(successCallback) {
    const sampleEvents = [
      {
        title: 'Juan P칠rez - Hab. 101',
        start: new Date(),
        end: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
        extendedProps: {
          tipo: 'reservacion',
          correo: 'juan@email.com',
          telefono: '555-1234'
        }
      },
      {
        title: 'Mar칤a Garc칤a - Hab. 102',
        start: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000),
        end: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
        extendedProps: {
          tipo: 'renta',
          correo: 'maria@email.com',
          telefono: '555-5678'
        }
      },
      {
        title: 'Carlos L칩pez - Hab. 103',
        start: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000),
        end: new Date(Date.now() + 8 * 24 * 60 * 60 * 1000),
        extendedProps: {
          tipo: 'reservacion',
          correo: 'carlos@email.com',
          telefono: '555-9012'
        }
      }
    ];
    successCallback(sampleEvents);
  }

  // Inicializar el calendario cuando el DOM est칠 listo
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM cargado, inicializando calendario...');

    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
      console.error('No se encontr칩 el elemento con id "calendar"');
      return;
    }

    // Verificar si FullCalendar est치 disponible
    if (typeof FullCalendar === 'undefined') {
      console.error('FullCalendar no est치 cargado. Verifica la ruta del script.');
      return;
    }

    console.log('FullCalendar disponible, creando instancia...');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      firstDay: 1,
      fixedWeekCount: false,
      dayMaxEvents: 3,
      eventDisplay: 'block',
      displayEventTime: false,

      headerToolbar: {
        left: 'prev,next',
        center: 'title',
        right: 'today'
      },

      buttonText: {
        today: 'Hoy'
      },

      eventClick: function(info) {
        info.jsEvent.preventDefault();
        openViewEventModal(info.event);
      },

      eventDidMount: function(info) {
        if (info.event.extendedProps.tipo === 'renta') {
          info.el.classList.add('fc-event-renta');
        } else {
          info.el.classList.add('fc-event-reservacion');
        }

        info.el.style.cursor = 'pointer';
        info.el.title = `${info.event.title} - Click para m치s detalles`;
      },

      events: function(fetchInfo, successCallback, failureCallback) {
        console.log('Solicitando eventos del calendario...');

        // Primero intentar cargar desde la API
        fetch('/rooms/calendario/eventos')
          .then(response => {
            if (!response.ok) {
              throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
          })
          .then(events => {
            console.log('Eventos cargados desde API:', events);
            successCallback(events);
            updateStats(events);
            updateCurrentMonth(calendar);
          })
          .catch(error => {
            console.error('Error cargando eventos desde API:', error);
            console.log('Cargando eventos de ejemplo...');
            // Si falla, cargar eventos de ejemplo
            loadSampleEvents(successCallback);
          });
      },

      datesSet: function(info) {
        updateCurrentMonth(calendar);
      }
    });

    console.log('Calendario configurado, renderizando...');
    calendar.render();
    console.log('Calendario renderizado');

    function updateStats(events) {
      const totalEvents = events.length;
      const rentas = events.filter(e => e.extendedProps?.tipo === 'renta').length;
      const reservaciones = events.filter(e => e.extendedProps?.tipo === 'reservacion').length;

      document.getElementById('total-events').textContent = totalEvents;
      document.getElementById('total-rentas').textContent = rentas;
      document.getElementById('total-reservaciones').textContent = reservaciones;
    }

    function updateCurrentMonth(calendar) {
      const currentDate = calendar.getDate();
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                         'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const currentMonth = monthNames[currentDate.getMonth()];
      const currentYear = currentDate.getFullYear();
      document.getElementById('current-month').textContent = `${currentMonth} ${currentYear}`;
    }

    // Manejo de par치metros URL para actualizaciones
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('updated') === 'true') {
      setTimeout(function() {
        console.log('Actualizando calendario desde par치metro URL...');
        calendar.refetchEvents();
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
      }, 1000);
    }

    // Actualizaci칩n autom치tica cada 30 segundos
    setInterval(function() {
      console.log('Actualizaci칩n autom치tica del calendario...');
      calendar.refetchEvents();
    }, 30000);

    // Funci칩n global para actualizar manualmente
    window.refreshCalendar = function() {
      console.log('Actualizaci칩n manual del calendario...');
      calendar.refetchEvents();
      const button = event.target.closest('button');
      if (button) {
        const originalHTML = button.innerHTML;
        button.innerHTML = '<svg class="w-5 h-5 animate-spin inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Actualizando...';
        setTimeout(() => {
          button.innerHTML = originalHTML;
        }, 1000);
      }
    };

    // Inicializar con eventos de ejemplo inmediatamente
    setTimeout(() => {
      if (calendar.getEvents().length === 0) {
        console.log('No hay eventos, cargando ejemplos...');
        loadSampleEvents(function(events) {
          events.forEach(event => calendar.addEvent(event));
          updateStats(events);
        });
      }
    }, 500);
  });
</script>

<style>
  /* ESTILOS ESENCIALES PARA EL CALENDARIO */
  .fc {
    font-family: 'Segoe UI', system-ui, sans-serif;
    width: 100%;
  }

  /* Toolbar del calendario */
  .fc .fc-toolbar {
    padding: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin: 0;
  }

  .fc .fc-toolbar-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
  }

  .fc .fc-button {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .fc .fc-button:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Encabezados de d칤as */
  .fc .fc-col-header-cell {
    background: #f8fafc;
    padding: 0.75rem 0.5rem;
    border: 1px solid #e2e8f0;
  }

  .fc .fc-col-header-cell-cushion {
    color: #374151;
    font-weight: 600;
    text-decoration: none;
    font-size: 0.875rem;
  }

  /* Celdas de d칤as */
  .fc .fc-daygrid-day {
    border: 1px solid #e2e8f0;
    min-height: 50px;
  }

  .fc .fc-daygrid-day-frame {
    min-height: 50px;
    padding: 0.25rem;
  }

  .fc .fc-daygrid-day-number {
    color: #374151;
    font-weight: 600;
    padding: 0.5rem;
    font-size: 0.875rem;
  }

  .fc .fc-day-today {
    background-color: #eff6ff !important;
  }

  .fc .fc-day-today .fc-daygrid-day-number {
    color: #2563eb;
    font-weight: 800;
  }

  /* Eventos */
  .fc-event {
    border: none;
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    margin: 1px;
    cursor: pointer;
  }

  .fc-event-renta {
    background: #10b981;
    color: white;
  }

  .fc-event-reservacion {
    background: #3b82f6;
    color: white;
  }

  .fc-event:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .fc .fc-toolbar {
      flex-direction: column;
      gap: 1rem;
      padding: 0.75rem;
    }

    .fc .fc-toolbar-title {
      font-size: 1.125rem;
    }

    .fc .fc-button {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }

    .fc .fc-daygrid-day-frame {
      min-height: 80px;
    }

    .fc .fc-daygrid-day-number {
      font-size: 0.75rem;
      padding: 0.25rem;
    }

    .fc-event {
      font-size: 0.65rem;
      padding: 0.125rem 0.25rem;
    }
  }

  /* Asegurar que el calendario ocupe espacio */
  #calendar {
    min-height: 600px;
  }

  .fc .fc-view-harness {
    min-height: 500px;
  }
</style>

<!-- Incluir tu librer칤a local de FullCalendar -->
<script src="/js/ModuleRooms/js/lib/fullcalendar@6.1.8/index.global.min.js"></script>
