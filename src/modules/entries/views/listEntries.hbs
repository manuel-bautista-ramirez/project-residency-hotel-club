<style>
  .entry-row {
    transition: all 0.2s;
    border-radius: 12px;
  }

  .entry-row:hover {
    transform: scale(1.005);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  }

  .table-container::-webkit-scrollbar {
    height: 8px;
  }

  .table-container::-webkit-scrollbar-thumb {
    background: #e5e7eb;
    border-radius: 10px;
  }
</style>

<main class="pt-20 px-4 sm:px-8 max-w-screen-xl mx-auto">
  <section class="bg-white rounded-[2rem] shadow-2xl p-6 md:p-8 border border-gray-100">

    <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
      <div>
        <h1 class="text-3xl font-black text-gray-800 tracking-tighter">Control de Registros</h1>
        <p class="text-gray-400 text-sm font-medium">Visualización de ingresos históricos</p>
      </div>

      <div class="flex flex-wrap justify-center gap-4">
        <a href="/entries"
          class="flex items-center gap-2 px-6 py-3 bg-white border border-gray-200 text-gray-700 rounded-2xl font-bold text-sm hover:bg-gray-50 transition shadow-sm">
          <i class="fas fa-home text-lg sm:text-sm"></i> <span class="hidden sm:inline">Principal</span>
        </a>
        {{#if (eq user.role "Administrador")}}
        <a href="/entries/reports"
          class="flex items-center gap-2 px-6 py-3 bg-white border border-gray-200 text-gray-700 rounded-2xl font-bold text-sm hover:bg-gray-50 transition shadow-sm">
          <i class="fas fa-chart-pie text-lg sm:text-sm"></i> <span class="hidden sm:inline">Ver Reportes</span>
        </a>
        <button id="btnBulkDelete" onclick="deleteSelected()"
          class="hidden bg-red-600 text-white px-6 py-2.5 rounded-2xl font-bold transition shadow-lg items-center gap-2">
          <i class="fas fa-trash-alt text-lg sm:text-sm"></i> <span class="hidden sm:inline">Eliminar Seleccionados
            (<span id="selectedCount">0</span>)</span>
        </button>
        {{/if}}
      </div>
    </header>

    {{#if entries}}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 bg-gray-50 p-4 rounded-3xl border border-gray-100">
      <input type="text" id="nameSearch" onkeyup="dualFilter()" placeholder="Buscar por nombre..."
        class="w-full px-5 py-3 bg-white border border-gray-200 rounded-2xl focus:ring-2 focus:ring-indigo-400 focus:outline-none text-sm leading-none pl-12"
        style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%239ca3af%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><circle cx=%2211%22 cy=%2211%22 r=%228%22></circle><line x1=%2221%22 y1=%2221%22 x2=%2216.65%22 y2=%2216.65%22></line></svg>'); background-repeat: no-repeat; background-position: 1rem center;">
      <input type="text" id="dateSearch" onkeyup="dualFilter()" placeholder="Buscar por fecha (DD/MM/AAAA)..."
        class="w-full px-5 py-3 bg-white border border-gray-200 rounded-2xl focus:ring-2 focus:ring-indigo-400 focus:outline-none text-sm leading-none pl-12"
        style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%239ca3af%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect x=%223%22 y=%224%22 width=%2218%22 height=%2218%22 rx=%222%22 ry=%222%22></rect><line x1=%2216%22 y1=%222%22 x2=%2216%22 y2=%226%22></line><line x1=%228%22 y1=%222%22 x2=%228%22 y2=%226%22></line><line x1=%223%22 y1=%2210%22 x2=%2221%22 y2=%2210%22></line></svg>'); background-repeat: no-repeat; background-position: 1rem center;">
    </div>

    <!-- VISTA DE ESCRITORIO (TABLA) -->
    <div class="hidden lg:block table-container overflow-x-auto">
      <table class="min-w-full border-separate border-spacing-y-3" id="entriesTable">
        <thead>
          <tr class="text-gray-400 text-[10px] uppercase tracking-[0.2em]">
            {{#if (eq user.role "Administrador")}}
            <th class="px-6 py-2 text-left"><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"
                class="w-4 h-4 rounded border-gray-300 text-indigo-600"></th>
            {{/if}}
            <th class="px-6 py-2 text-left">ID</th>
            <th class="px-6 py-2 text-left">Nombre</th>
            <th class="px-6 py-2 text-left">Área</th>
            <th class="px-6 py-2 text-left">Costo</th>
            <th class="px-6 py-2 text-left">Pago</th>
            <th class="px-6 py-2 text-left">Fecha</th>
            <th class="px-6 py-2 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tableBody"> {{#each entries}}
          <tr class="entry-row bg-white border border-gray-100 shadow-sm">
            {{#if (eq ../user.role "Administrador")}}
            <td class="px-6 py-4 rounded-l-2xl border-y border-l border-gray-50">
              <input type="checkbox" class="row-checkbox w-4 h-4 rounded text-indigo-600 border-gray-300"
                value="{{this.id}}" onchange="updateBulkButton()">
            </td>
            {{/if}}

            <td class="px-6 py-4 text-sm font-black text-indigo-900 border-y border-gray-50">#{{this.visual_id}}</td>

            <td class="px-6 py-4 border-y border-gray-50 search-name">
              <div class="flex flex-col">
                <span class="text-sm font-bold text-gray-800">{{this.first_name}}</span>
                <span class="text-xs text-gray-400 uppercase tracking-widest">{{this.last_name}}</span>
              </div>
            </td>

            <td class="px-6 py-4 border-y border-gray-50">
              <span class="px-3 py-1 text-[10px] font-black rounded-lg uppercase
                  {{#if (eq this.area 'Canchas')}} bg-blue-50 text-blue-600 {{/if}}
                  {{#if (eq this.area 'Alberca')}} bg-emerald-50 text-emerald-600 {{/if}}
                  {{#if (eq this.area 'Gimnasio')}} bg-amber-50 text-amber-600 {{/if}}">
                {{this.area}}
              </span>
            </td>

            <td class="px-6 py-4 text-sm font-black text-gray-900 border-y border-gray-50">${{this.cost}}</td>
            <td class="px-6 py-4 text-xs font-semibold text-gray-500 border-y border-gray-50">{{this.payment_method}}
            </td>
            <td class="px-6 py-4 text-[11px] font-medium text-gray-400 border-y border-gray-50 search-date">
              {{this.entry_date}}</td>

            <td class="px-6 py-4 text-center rounded-r-2xl border-y border-r border-gray-50">
              {{#if (eq ../user.role "Administrador")}}
              <div class="flex items-center justify-center gap-2">
                <button onclick="editEntry('{{this.id}}', '{{this.first_name}}', '{{this.last_name}}')"
                  class="p-2 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white transition shadow-sm">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="confirmSingleDelete('{{this.id}}')"
                  class="p-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-600 hover:text-white transition shadow-sm">
                  <i class="fas fa-trash"></i>
                </button>
                <form id="delete-form-{{this.id}}" action="/api/entries/{{this.id}}/delete" method="POST"
                  class="hidden"></form>
              </div>
              {{else}}
              <span class="text-gray-300"><i class="fas fa-lock"></i></span>
              {{/if}}
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>

    <!-- VISTA MÓVIL (CARDS) -->
    <div class="lg:hidden grid grid-cols-1 md:grid-cols-2 gap-4">
      {{#each entries}}
      <div class="entry-row bg-white rounded-2xl shadow-sm border border-gray-100 p-5 relative overflow-hidden group">
        <!-- Decoración de fondo -->
        <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
          <i class="fas fa-ticket-alt text-6xl text-indigo-900"></i>
        </div>

        <!-- Encabezado Card -->
        <div class="flex justify-between items-start mb-4 relative z-10">
          <div>
            <span class="px-2.5 py-1 text-[10px] font-black rounded-lg uppercase tracking-wide
              {{#if (eq this.area 'Canchas')}} bg-blue-50 text-blue-600 {{/if}}
              {{#if (eq this.area 'Alberca')}} bg-emerald-50 text-emerald-600 {{/if}}
              {{#if (eq this.area 'Gimnasio')}} bg-amber-50 text-amber-600 {{/if}}">
              {{this.area}}
            </span>
            <div class="mt-2 search-name">
              <h3 class="text-lg font-bold text-gray-900 leading-tight">{{this.first_name}}</h3>
              <p class="text-xs text-gray-500 uppercase tracking-widest font-medium">{{this.last_name}}</p>
            </div>
          </div>
          <div class="text-right">
            <span class="block text-xl font-black text-indigo-900">${{this.cost}}</span>
            <span class="text-[10px] font-semibold text-gray-400">#{{this.visual_id}}</span>
          </div>
        </div>

        <!-- Detalles -->
        <div
          class="flex items-center justify-between text-xs text-gray-500 bg-gray-50 rounded-xl p-3 mb-4 border border-gray-100">
          <div class="flex items-center gap-1.5">
            <i class="fas fa-wallet text-gray-400"></i>
            <span class="font-medium">{{this.payment_method}}</span>
          </div>
          <div class="flex items-center gap-1.5 search-date">
            <i class="far fa-calendar text-gray-400"></i>
            <span>{{this.entry_date}}</span>
          </div>
        </div>

        <!-- Acciones -->
        {{#if (eq ../user.role "Administrador")}}
        <div class="flex gap-2 pt-1">
          <button onclick="editEntry('{{this.id}}', '{{this.first_name}}', '{{this.last_name}}')"
            class="flex-1 flex items-center justify-center gap-2 bg-blue-50 hover:bg-blue-100 text-blue-600 py-2.5 rounded-xl text-xs font-bold transition-all duration-200">
            <i class="fas fa-edit text-lg sm:text-xs"></i> <span class="hidden sm:inline">Editar</span>
          </button>
          <button onclick="confirmSingleDelete('{{this.id}}')"
            class="flex-1 flex items-center justify-center gap-2 bg-red-50 hover:bg-red-100 text-red-600 py-2.5 rounded-xl text-xs font-bold transition-all duration-200">
            <i class="fas fa-trash text-lg sm:text-xs"></i> <span class="hidden sm:inline">Eliminar</span>
          </button>
        </div>
        {{else}}
        <div class="text-center py-2 bg-gray-50 rounded-xl border border-gray-100">
          <span class="text-xs text-gray-400 font-medium"><i class="fas fa-lock mr-1"></i> Solo lectura</span>
        </div>
        {{/if}}
      </div>
      {{/each}}
    </div>
    {{else}}
    <div class="text-center py-20 animate-fade-in">
      <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-folder-open text-4xl text-indigo-300"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">No hay registros hoy</h3>
      <p class="text-gray-400 mb-8 max-w-sm mx-auto">No se han encontrado registros de entrada en la base de datos.</p>
      <a href="/entries"
        class="inline-flex items-center gap-2 bg-indigo-600 text-white px-8 py-3 rounded-2xl hover:bg-indigo-700 transition shadow-lg hover:shadow-indigo-200 font-bold transform hover:-translate-y-1">
        <i class="fas fa-arrow-left"></i>
        Regresar
      </a>
    </div>
    {{/if}}
  </section>
</main>


<script>
  const colors = { primary: '#4f46e5', danger: '#ef4444', success: '#10b981', background: '#ffffff' };

  // --- NUEVA LÓGICA DE ORDENAMIENTO (CORRECCIÓN) ---
  // Esta función se ejecuta al cargar y voltea las filas para que el ID #1 esté arriba
  document.addEventListener('DOMContentLoaded', () => {
    const tbody = document.getElementById('tableBody');
    const rows = Array.from(tbody.querySelectorAll('.entry-row'));
    // Invertimos las filas: la última persona registrada irá abajo del todo
    // y la primera (ID 1) quedará arriba.
    rows.reverse().forEach(row => tbody.appendChild(row));
  });

  function dualFilter() {
    const nameQ = document.getElementById('nameSearch').value.toLowerCase();
    const dateQ = document.getElementById('dateSearch').value.toLowerCase();
    document.querySelectorAll('.entry-row').forEach(row => {
      const name = row.querySelector('.search-name').textContent.toLowerCase();
      const date = row.querySelector('.search-date').textContent.toLowerCase();
      row.style.display = (name.includes(nameQ) && date.includes(dateQ)) ? '' : 'none';
    });
  }

  function toggleAllCheckboxes() {
    const isChecked = document.getElementById('selectAll').checked;
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked);
    updateBulkButton();
  }

  function updateBulkButton() {
    const selected = document.querySelectorAll('.row-checkbox:checked');
    const btn = document.getElementById('btnBulkDelete');
    if (btn) {
      btn.classList.toggle('hidden', selected.length === 0);
      btn.classList.toggle('flex', selected.length > 0);
      document.getElementById('selectedCount').textContent = selected.length;
    }
  }

  async function editEntry(id, currentName, currentLast) {
    const { value: formValues } = await Swal.fire({
      title: '<span style="color:#1e1b4b; font-family:sans-serif;">Editar Registro</span>',
      html:
        `<div style="text-align:left; font-size:14px; color:#64748b; margin-bottom:8px;">Nombre(s)</div>` +
        `<input id="swal-name" class="swal2-input" style="margin-top:0; border-radius:12px; font-size:16px;" value="${currentName}">` +
        `<div style="text-align:left; font-size:14px; color:#64748b; margin-bottom:8px; margin-top:15px;">Apellidos</div>` +
        `<input id="swal-last" class="swal2-input" style="margin-top:0; border-radius:12px; font-size:16px;" value="${currentLast}">`,
      showCancelButton: true,
      confirmButtonText: 'Actualizar Datos',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: colors.primary,
      cancelButtonColor: '#94a3b8',
      borderRadius: '2rem',
      preConfirm: () => {
        const name = document.getElementById('swal-name').value;
        const last = document.getElementById('swal-last').value;
        if (!name || !last) { Swal.showValidationMessage('Ambos campos son obligatorios'); }
        return { first_name: name, last_name: last }
      }
    });

    if (formValues) {
      if (typeof window.showNotification === 'function') {
        window.showNotification('Actualizando datos del registro...', 'info');
      }

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/api/entries/${id}/edit`;
      for (const key in formValues) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = formValues[key];
        form.appendChild(input);
      }
      document.body.appendChild(form);

      setTimeout(() => {
        form.submit();
      }, 800);
    }
  }

  async function confirmSingleDelete(id) {
    const result = await Swal.fire({
      title: '¿Eliminar este registro?',
      text: "Esta acción no se puede deshacer.",
      icon: 'warning',
      iconColor: colors.danger,
      showCancelButton: true,
      confirmButtonColor: colors.danger,
      cancelButtonColor: '#94a3b8',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar',
      borderRadius: '2rem'
    });
    if (result.isConfirmed) {
      if (typeof window.showNotification === 'function') {
        window.showNotification('Eliminando registro...', 'info');
      }

      setTimeout(() => {
        document.getElementById(`delete-form-${id}`).submit();
      }, 800);
    }
  }

  async function deleteSelected() {
    const selected = document.querySelectorAll('.row-checkbox:checked');
    const ids = Array.from(selected).map(cb => cb.value);
    const result = await Swal.fire({
      title: `¿Borrar ${ids.length} registros?`,
      icon: 'error',
      showCancelButton: true,
      confirmButtonColor: colors.danger,
      confirmButtonText: 'Eliminar lote',
      borderRadius: '2rem'
    });

    if (result.isConfirmed) {
      const btn = document.getElementById('btnBulkDelete');
      let originalHTML = '';
      if (typeof window.setLoadingState === 'function') {
        originalHTML = window.setLoadingState(btn, 'Borrando...');
      }

      try {
        const response = await fetch('/api/entries/bulk-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });

        if (response.ok) {
          if (typeof window.showNotification === 'function') {
            window.showNotification(`${ids.length} registros eliminados con éxito`, 'success');
          }
          setTimeout(() => location.reload(), 1500);
        } else {
          throw new Error('No se pudo eliminar el lote');
        }
      } catch (err) {
        if (typeof window.showNotification === 'function') {
          window.showNotification(err.message, 'error');
        }
        if (typeof window.removeLoadingState === 'function') {
          window.removeLoadingState(btn, originalHTML);
        }
      }
    }
  }
</script>

<script src="/js/ModuleEntries/js/entriesValidation.js"></script>
