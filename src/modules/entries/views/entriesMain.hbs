<style>
  /* Animación para precio modificado */
  .precio-especial {
    background-color: #fffbeb !important;
    border: 2px solid #fbbf24 !important;
    transform: translateY(-4px);
    box-shadow: 0 12px 20px -5px rgba(251, 191, 36, 0.3);
  }

  .card-area {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }

  .input-readonly {
    background: transparent !important;
    border: none !important;
    outline: none !important;
    cursor: default;
    pointer-events: none;
  }

  /* Ajuste para que los números tengan espacio */
  .price-input {
    letter-spacing: -0.02em;
    min-width: 100px;
  }

  .btn-select-canchas {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
  }

  .btn-select-alberca {
    background: linear-gradient(135deg, #0d9488, #0f766e);
  }

  .btn-select-gym {
    background: linear-gradient(135deg, #d97706, #b45309);
  }
</style>

<main class="pt-20 max-w-screen-xl mx-auto px-4">
  <section class="bg-white rounded-[2.5rem] shadow-2xl p-8 md:p-12 border border-gray-50">

    <header class="text-center mb-12">
      <span
        class="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-xs font-black uppercase tracking-widest">Recepción
        Hotel Club</span>
      <h1 class="text-4xl font-black text-gray-900 mt-4 tracking-tight">Registro de Visitantes</h1>
      <p class="text-gray-400 mt-2 font-medium">Capture los datos del cliente y seleccione el área de acceso.</p>
    </header>

    <form id="entryForm" action="/api/entries" method="POST" class="space-y-8" data-loading
      data-loading-message="Registrando entrada..." data-loading-subtext="Guardando registro">

      <div class="bg-gray-50 p-8 rounded-[2rem] border border-gray-100">
        <h2 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-6 flex items-center gap-2">
          <span
            class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-[10px]">01</span>
          Información del Cliente
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="relative">
            <label for="first_name" class="block text-xs font-bold text-gray-500 uppercase ml-1 mb-2">Nombre(s)</label>
            <input type="text" id="first_name" name="first_name" placeholder="Ej. Juan"
              class="w-full rounded-2xl border-gray-200 bg-white px-5 py-3.5 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition-all outline-none text-gray-700 font-medium shadow-sm">
          </div>
          <div class="relative">
            <label for="last_name" class="block text-xs font-bold text-gray-500 uppercase ml-1 mb-2">Apellido(s)</label>
            <input type="text" id="last_name" name="last_name" placeholder="Ej. Pérez"
              class="w-full rounded-2xl border-gray-200 bg-white px-5 py-3.5 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition-all outline-none text-gray-700 font-medium shadow-sm">
          </div>
        </div>

        <div class="mt-8">
          <label class="block text-xs font-bold text-gray-500 uppercase ml-1 mb-4">Método de Pago Preferido</label>
          <div class="flex gap-4">
            <label class="flex-1 relative cursor-pointer group">
              <input type="radio" name="payment_method" value="Efectivo" checked class="peer hidden">
              <div
                class="bg-white border-2 border-gray-100 p-4 rounded-2xl text-center font-bold text-gray-500 peer-checked:border-indigo-600 peer-checked:text-indigo-600 peer-checked:bg-indigo-50 transition-all group-hover:border-indigo-200 shadow-sm">
                <i class="fas fa-money-bill-wave mr-2"></i> Efectivo
              </div>
            </label>
            <label class="flex-1 relative cursor-pointer group">
              <input type="radio" name="payment_method" value="Transferencia" class="peer hidden">
              <div
                class="bg-white border-2 border-gray-100 p-4 rounded-2xl text-center font-bold text-gray-500 peer-checked:border-indigo-600 peer-checked:text-indigo-600 peer-checked:bg-indigo-50 transition-all group-hover:border-indigo-200 shadow-sm">
                <i class="fas fa-mobile-alt mr-2"></i> Transferencia
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="bg-gray-50 p-8 rounded-[2rem] border border-gray-100">
        <h2 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-6 flex items-center gap-2">
          <span
            class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-[10px]">02</span>
          Seleccione Área y Tarifa
        </h2>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div
            class="card-area rounded-[2rem] p-6 bg-white border border-gray-200 shadow-sm flex flex-col justify-between">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-blue-50 text-blue-600 rounded-2xl text-2xl"><i class="fas fa-table-tennis"></i></div>
              <span
                class="text-[9px] font-black bg-blue-100 text-blue-700 px-2 py-1 rounded-lg uppercase">Canchas</span>
            </div>
            <div class="flex items-baseline gap-1 mb-6">
              <span class="text-xl font-bold text-gray-400">$</span>
              <input type="number" id="price_canchas" value="{{prices.price_canchas}}" readonly
                class="price-input w-32 text-4xl font-black text-indigo-600 bg-transparent outline-none cursor-default">
            </div>
            <button type="button" onclick="selectArea('Canchas', 'price_canchas', this)"
              class="btn-select-canchas w-full text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:scale-[1.02] active:scale-95 transition-all uppercase text-[10px] tracking-widest flex items-center justify-center gap-2">
              <i class="fas fa-check-circle text-lg sm:text-[10px]"></i> <span
                class="hidden sm:inline">Seleccionar</span>
            </button>
          </div>

          <div
            class="card-area rounded-[2rem] p-6 bg-white border border-gray-200 shadow-sm flex flex-col justify-between">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-teal-50 text-teal-600 rounded-2xl text-2xl"><i class="fas fa-swimmer"></i></div>
              <span
                class="text-[9px] font-black bg-teal-100 text-teal-700 px-2 py-1 rounded-lg uppercase">Alberca</span>
            </div>
            <div class="flex items-baseline gap-1 mb-6">
              <span class="text-xl font-bold text-gray-400">$</span>
              <input type="number" id="price_alberca" value="{{prices.price_alberca}}" readonly
                class="price-input w-32 text-4xl font-black text-teal-600 bg-transparent outline-none cursor-default">
            </div>
            <button type="button" onclick="selectArea('Alberca', 'price_alberca', this)"
              class="btn-select-alberca w-full text-white py-4 rounded-2xl font-bold shadow-lg shadow-teal-200 hover:scale-[1.02] active:scale-95 transition-all uppercase text-[10px] tracking-widest flex items-center justify-center gap-2">
              <i class="fas fa-check-circle text-lg sm:text-[10px]"></i> <span
                class="hidden sm:inline">Seleccionar</span>
            </button>
          </div>

          <div
            class="card-area rounded-[2rem] p-6 bg-white border border-gray-200 shadow-sm flex flex-col justify-between">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-amber-50 text-amber-600 rounded-2xl text-2xl"><i class="fas fa-dumbbell"></i></div>
              <span
                class="text-[9px] font-black bg-amber-100 text-amber-700 px-2 py-1 rounded-lg uppercase">Gimnasio</span>
            </div>
            <div class="flex items-baseline gap-1 mb-6">
              <span class="text-xl font-bold text-gray-400">$</span>
              <input type="number" id="price_gym" value="{{prices.price_gym}}" readonly
                class="price-input w-32 text-4xl font-black text-amber-600 bg-transparent outline-none cursor-default">
            </div>
            <button type="button" onclick="selectArea('Gimnasio', 'price_gym', this)"
              class="btn-select-gym w-full text-white py-4 rounded-2xl font-bold shadow-lg shadow-amber-200 hover:scale-[1.02] active:scale-95 transition-all uppercase text-[10px] tracking-widest flex items-center justify-center gap-2">
              <i class="fas fa-check-circle text-lg sm:text-[10px]"></i> <span
                class="hidden sm:inline">Seleccionar</span>
            </button>
          </div>
        </div>
      </div>

      <input type="hidden" id="selected_area" name="area">
      <input type="hidden" id="selected_cost" name="cost">
    </form>

    <div class="mt-16 flex flex-wrap justify-center gap-4 border-t border-gray-100 pt-10">
      <a href="/entries/list"
        class="flex items-center gap-2 px-6 py-3 bg-white border border-gray-200 text-gray-700 rounded-2xl font-bold text-sm hover:bg-gray-50 transition shadow-sm">
        <i class="fas fa-clipboard-list text-lg sm:text-sm"></i> <span class="hidden sm:inline">Ver Registros</span>
      </a>

      {{#if (eq user.role "Administrador")}}
      <a href="/entries/reports"
        class="flex items-center gap-2 px-6 py-3 bg-white border border-gray-200 text-gray-700 rounded-2xl font-bold text-sm hover:bg-gray-50 transition shadow-sm">
        <i class="fas fa-chart-line text-lg sm:text-sm"></i> <span class="hidden sm:inline">Reportes de Ingresos</span>
      </a>
      {{else}}
      <button onclick="restrictedAccess()"
        class="flex items-center gap-2 px-6 py-3 bg-white border border-gray-200 text-gray-400 rounded-2xl font-bold text-sm hover:bg-gray-50 transition shadow-sm">
        <i class="fas fa-lock text-lg sm:text-sm"></i> <span class="hidden sm:inline">Reportes de Ingresos</span>
      </button>
      {{/if}}
    </div>

    {{#if (eq user.role "Administrador")}}
    <div class="mt-20 p-8 bg-gray-50 rounded-[2.5rem] border border-gray-100 relative overflow-hidden">
      <div class="absolute top-0 right-0 p-8 opacity-5 text-8xl grayscale"><i class="fas fa-cog"></i></div>
      <div class="relative z-10">
        <div class="flex items-center gap-4 mb-8">
          <div
            class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center text-xl shadow-sm">
            <i class="fas fa-tools"></i>
          </div>
          <div>
            <h2 class="text-xl font-black uppercase tracking-tight text-gray-800">Configuración de Tarifas Base</h2>
            <p class="text-gray-400 text-xs font-medium">Precios predeterminados en la base de datos.</p>
          </div>
        </div>
        <form id="settingsForm" novalidate class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
          <div>
            <label class="block text-[10px] font-black uppercase tracking-widest mb-2 text-gray-400">Canchas</label>
            <input type="number" name="price_canchas" value="{{prices.price_canchas}}" step="10"
              class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition text-gray-700 font-bold shadow-sm">
          </div>
          <div>
            <label class="block text-[10px] font-black uppercase tracking-widest mb-2 text-gray-400">Alberca</label>
            <input type="number" name="price_alberca" value="{{prices.price_alberca}}" step="10"
              class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition text-gray-700 font-bold shadow-sm">
          </div>
          <div>
            <label class="block text-[10px] font-black uppercase tracking-widest mb-2 text-gray-400">Gimnasio</label>
            <input type="number" name="price_gym" value="{{prices.price_gym}}" step="10"
              class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition text-gray-700 font-bold shadow-sm">
          </div>
          <button type="submit"
            class="bg-indigo-600 text-white py-3.5 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
            <i class="fas fa-save text-lg sm:text-xs"></i> <span class="hidden sm:inline">Actualizar Tarifas</span>
          </button>
        </form>
      </div>
    </div>
    {{/if}}

  </section>
</main>

<!-- Validaciones Estilo Store -->
<script src="/js/ModuleEntries/js/entriesValidation.js"></script>

<script>
  let lastSelectedCard = null;
  const clubColors = { primary: '#4f46e5', danger: '#ef4444', success: '#16a34a' };

  // Controlar incremento de 10 en 10 manual pero permitir cualquier valor
  document.querySelectorAll('#settingsForm input[type="number"]').forEach(input => {
    input.addEventListener('keydown', (e) => {
      // Si el usuario usa las flechas, cambiamos de 10 en 10
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        input.value = (parseFloat(input.value) || 0) + 10;
        input.dispatchEvent(new Event('input')); // Notificar cambio
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        input.value = Math.max(0, (parseFloat(input.value) || 0) - 10);
        input.dispatchEvent(new Event('input')); // Notificar cambio
      }
    });
  });

  // Resaltar si el Admin cambia el precio manualmente
  document.querySelectorAll('.price-input').forEach(input => {
    input.addEventListener('input', (e) => {
      const card = e.target.closest('.card-area');
      const original = e.target.getAttribute('data-original');
      card.classList.toggle('precio-especial', e.target.value !== original);
    });
  });

  function restrictedAccess() {
    showNotification('Solo el administrador tiene permisos para ver los reportes de ingresos.', 'error');
  }

  function selectArea(areaName, inputId, btn) {
    const precioActual = document.getElementById(inputId).value;
    const firstName = document.getElementById('first_name').value.trim();
    const lastName = document.getElementById('last_name').value.trim();
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;

    // Usar la nueva lógica de validación visual
    if (typeof window.validateEntryForm === 'function') {
      if (!window.validateEntryForm()) return;
    } else if (!firstName || !lastName) {
      showNotification('Complete nombre y apellido antes de continuar.', 'warning');
      return;
    }

    document.getElementById('selected_area').value = areaName;
    document.getElementById('selected_cost').value = precioActual;

    if (lastSelectedCard) lastSelectedCard.classList.remove('ring-4', 'ring-indigo-500', 'scale-[1.03]');
    const card = btn.closest('.card-area');
    card.classList.add('ring-4', 'ring-indigo-500', 'scale-[1.03]');
    lastSelectedCard = card;

    const submitEntry = () => {
      // Bloquear todos los botones de selección para evitar doble clic
      document.querySelectorAll('.card-area button').forEach(b => {
        b.disabled = true;
        b.classList.add('opacity-50', 'cursor-not-allowed');
      });

      setTimeout(() => {
        const form = document.getElementById('entryForm');
        if (!form) return;
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.submit();
        }
      }, 500);
    };

    if (typeof Swal === 'undefined') {
      const confirmed = confirm(
        `Confirmar Registro\n\nVisitante: ${firstName} ${lastName}\nÁrea: ${areaName}\nCosto: $${Math.round(precioActual)}\nMétodo: ${paymentMethod}`
      );
      if (confirmed) submitEntry();
      return;
    }

    Swal.fire({
      title: '<span style="color:#1e1b4b">Confirmar Registro</span>',
      html: `
        <div style="text-align:left; background:#f8fafc; padding:20px; border-radius:1.5rem; border:1px solid #e2e8f0;">
          <p style="margin-bottom:8px;"><strong style="color:#64748b">Visitante:</strong> <span style="color:#1e293b; font-weight:800">${firstName} ${lastName}</span></p>
          <p style="margin-bottom:8px;"><strong style="color:#64748b">Área:</strong> <span style="color:#4f46e5; font-weight:800">${areaName}</span></p>
          <p style="margin-bottom:8px;"><strong style="color:#64748b">Costo:</strong> <span style="color:#10b981; font-weight:800">$${Math.round(precioActual)}</span></p>
          <p><strong style="color:#64748b">Método:</strong> <span style="color:#1e293b; font-weight:800">${paymentMethod}</span></p>
        </div>`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Confirmar y Registrar',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: clubColors.success,
      borderRadius: '2.5rem'
    }).then(result => {
      if (result.isConfirmed) {
        submitEntry();
      }
    });
  }

  function focusPrice(id) {
    const input = document.getElementById(id);
    if (!input.readOnly) input.focus();
  }

  // Manejo del formulario de configuración vía Promesas/Fetch
  const settingsForm = document.getElementById('settingsForm');
  if (settingsForm) {
    settingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = settingsForm.querySelector('button[type="submit"]');
      let originalHTML = '';

      const data = Object.fromEntries(new FormData(settingsForm).entries());

      if (typeof window.setLoadingState === 'function') {
        originalHTML = window.setLoadingState(submitBtn, 'Actualizando...');
      }

      try {
        const response = await fetch('/api/entries/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
          if (typeof window.showNotification === 'function') {
            window.showNotification(result.message || 'Tarifas actualizadas correctamente', 'success');
          }

          // Actualizamos los atributos data-original...
          const c = Math.round(data.price_canchas);
          const a = Math.round(data.price_alberca);
          const g = Math.round(data.price_gym);

          document.getElementById('price_canchas').setAttribute('data-original', c);
          document.getElementById('price_alberca').setAttribute('data-original', a);
          document.getElementById('price_gym').setAttribute('data-original', g);

          document.getElementById('price_canchas').value = c;
          document.getElementById('price_alberca').value = a;
          document.getElementById('price_gym').value = g;

          // También actualizamos los inputs del formulario de herramientas
          const settingsInputs = document.querySelectorAll('#settingsForm input[type="number"]');
          settingsInputs[0].value = c;
          settingsInputs[1].value = a;
          settingsInputs[2].value = g;

          // Removemos clases de resaltado
          document.querySelectorAll('.card-area').forEach(card => card.classList.remove('precio-especial'));
        } else {
          throw new Error(result.error || 'Error desconocido');
        }
      } catch (err) {
        if (typeof window.showNotification === 'function') {
          window.showNotification(err.message, 'error');
        }
      } finally {
        Swal.close();
        if (typeof window.removeLoadingState === 'function') {
          window.removeLoadingState(submitBtn, originalHTML);
        }
      }
    });
  }
</script>
