<!-- Navigation Header & Filtros Sticky -->
<div class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-30 pt-10">
  <div class="w-full px-3 sm:px-4 lg:px-8">
    <div class="mt-2 w-full border-t border-slate-100 pt-3">
      {{> storeNavButtons activePage="store" user=user}}
    </div>

    <!-- Filtros Integrados en Header -->
    <div class="py-3 sm:py-4">
      <div class="flex flex-col sm:flex-row gap-3">
        <div class="w-full relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400 text-lg"></i>
          </div>
          <input type="text" id="searchProduct" placeholder="Buscar productos..."
            class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm transition-all shadow-sm" />
        </div>
        <div class="w-full sm:w-56">
          <select id="filterCategory"
            class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white cursor-pointer transition-all shadow-sm">
            <option value="">Todas las categorías</option>
            <option value="bebidas">Bebidas</option>
            <option value="snacks">Snacks</option>
            <option value="comida">Comida</option>
            <option value="otros">Otros</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }
</style>
<!-- Contenido -->
<div class="w-full px-3 sm:px-4 lg:px-8  sm:pt-4 pb-7 animate-fade-in">

  <!-- Grid de Productos -->
  <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4 lg:gap-6">
    {{#if products}}
    {{#each products}}
    <div
      class="group product-card bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 ease-out flex flex-col border border-slate-100 overflow-hidden relative"
      data-id="{{this.id}}" data-nombre="{{this.nombre}}" data-precio="{{this.precio}}"
      data-categoria="{{this.categoria}}" data-stock="{{this.stock}}">

      <!-- Decoración de Categoría (Barra lateral) -->
      <div class="absolute left-0 top-0 bottom-0 w-1 z-10
        {{#if (eq this.categoria 'bebidas')}}bg-blue-500{{/if}}
        {{#if (eq this.categoria 'snacks')}}bg-orange-500{{/if}}
        {{#if (eq this.categoria 'comida')}}bg-green-500{{/if}}
        {{#if (eq this.categoria 'otros')}}bg-purple-500{{/if}}">
      </div>

      <!-- Imagen/Icono Container -->
      <div
        class="relative h-32 sm:h-40 lg:h-44 bg-gradient-to-b from-slate-50 to-white group-hover:from-slate-100 transition-colors duration-500">
        {{#if this.imagen}}
        <img src="{{this.imagen}}" alt="{{this.nombre}}"
          class="w-full h-full object-contain object-center transition-transform duration-700 ease-in-out group-hover:scale-105 p-4 drop-shadow-sm">
        {{else}}
        <div class="w-full h-full flex items-center justify-center">
          <div class="p-4 rounded-full bg-white shadow-sm transition-transform duration-500 group-hover:scale-105">
            <i class="text-3xl sm:text-4xl transition-colors duration-500
              {{#if (eq this.categoria 'bebidas')}}fas fa-wine-bottle text-blue-400 group-hover:text-blue-600{{/if}}
              {{#if (eq this.categoria 'snacks')}}fas fa-cookie-bite text-orange-400 group-hover:text-orange-600{{/if}}
              {{#if (eq this.categoria 'comida')}}fas fa-utensils text-green-400 group-hover:text-green-600{{/if}}
              {{#if (eq this.categoria 'otros')}}fas fa-tags text-purple-400 group-hover:text-purple-600{{/if}}
              {{#unless this.categoria}}fas fa-box-open text-slate-300{{/unless}}"></i>
          </div>
        </div>
        {{/if}}

        <!-- Badge de categoría flotante -->
        <div class="absolute top-3 right-3">
          <span class="flex items-center gap-1.5 px-2 py-0.5 backdrop-blur-md shadow-sm rounded-full text-[9px] font-black uppercase tracking-widest border
            {{#if (eq this.categoria 'bebidas')}}bg-blue-50/90 text-blue-700 border-blue-100{{/if}}
            {{#if (eq this.categoria 'snacks')}}bg-orange-50/90 text-orange-700 border-orange-100{{/if}}
            {{#if (eq this.categoria 'comida')}}bg-green-50/90 text-green-700 border-green-100{{/if}}
            {{#if (eq this.categoria 'otros')}}bg-purple-50/90 text-purple-700 border-purple-100{{/if}}">
            <i class="text-[8px]
              {{#if (eq this.categoria 'bebidas')}}fas fa-tint{{/if}}
              {{#if (eq this.categoria 'snacks')}}fas fa-cookie{{/if}}
              {{#if (eq this.categoria 'comida')}}fas fa-hamburger{{/if}}
              {{#if (eq this.categoria 'otros')}}fas fa-ellipsis-h{{/if}}"></i>
            {{this.categoria}}
          </span>
        </div>

        <!-- Indicador de Stock Bajo -->
        {{#if (and (gt this.stock 0) (lte this.stock 5))}}
        <div class="absolute bottom-2 right-2">
          <span
            class="flex items-center gap-1 text-[9px] font-bold text-orange-600 bg-white/90 px-1.5 py-0.5 rounded shadow-sm border border-orange-100 animate-pulse">
            <i class="fas fa-exclamation-triangle"></i> ¡Quedan {{this.stock}}!
          </span>
        </div>
        {{/if}}
      </div>

      <!-- Información del Producto -->
      <div class="p-4 flex-grow flex flex-col justify-between">
        <div>
          <h3
            class="text-sm font-bold text-slate-800 mb-1 leading-snug line-clamp-2 group-hover:text-blue-700 transition-colors">
            {{this.nombre}}
          </h3>
          <p class="text-[10px] uppercase tracking-wide font-semibold text-slate-400 mb-3">
            Stock: <span class="{{#if (eq this.stock 0)}}text-red-500{{else}}text-slate-600{{/if}}">{{#if (eq this.stock
              0)}}Agotado{{else}}{{this.stock}} pzs{{/if}}</span>
          </p>
        </div>

        <div class="flex items-center justify-between">
          <div class="flex flex-col">
            <span class="text-[10px] text-slate-400 font-bold uppercase invisible h-0">Precio</span>
            <div class="flex items-baseline gap-1">
              <span class="text-lg font-black text-slate-900">${{this.precio}}</span>
              <span class="text-[9px] text-slate-400 font-bold">MXN</span>
            </div>
          </div>

          <!-- Botón de Acción Compacto -->
          {{#if (gt this.stock 0)}}
          <button
            class="add-to-cart-btn w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center shadow-md hover:bg-blue-600 hover:scale-110 hover:shadow-lg transition-all duration-300 group/btn"
            data-product-id="{{this.id}}" title="Agregar al carrito">
            <i class="fas fa-cart-plus text-sm group-hover/btn:animate-bounce"></i>
          </button>
          {{else}}
          <span
            class="px-2 py-1 bg-slate-100 text-slate-400 text-[10px] font-bold rounded uppercase border border-slate-200 cursor-not-allowed">
            Agotado
          </span>
          {{/if}}
        </div>
      </div>
    </div>
    {{/each}}
    {{else}}
    <div class="col-span-full text-center py-12">
      <div class="bg-slate-50 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-box-open text-4xl text-slate-300"></i>
      </div>
      <p class="text-lg sm:text-xl font-semibold text-slate-600">No hay productos disponibles</p>
    </div>
    {{/if}}
  </div>
</div>

<!-- Botón Flotante del Carrito -->
<div id="cart-float-btn" class="fixed bottom-20 right-6 z-[100] hidden">
  <button onclick="openCartModal()"
    class="relative bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white p-4 rounded-full shadow-2xl hover:shadow-blue-300 transition-all hover:scale-110 active:scale-95">
    <i class="fas fa-shopping-cart text-2xl"></i>
    <span id="cart-count"
      class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center animate-pulse">0</span>
  </button>
</div>

<!-- Modal para Agregar Cantidad -->
<div id="quantity-modal"
  class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-[70] backdrop-blur-sm p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-in">
    <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
      <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
        <i class="fas fa-plus-circle text-blue-600"></i>
        Agregar al Carrito
      </h2>
    </div>

    <div class="p-6">
      <div class="mb-5 bg-blue-50 p-4 rounded-xl border border-blue-100">
        <p class="text-xs text-blue-600 uppercase font-bold tracking-wide mb-1">Producto</p>
        <p class="text-base font-bold text-gray-900" id="qty-product-name"></p>
        <p class="text-lg font-bold text-blue-700 mt-2" id="qty-product-price"></p>
      </div>

      <div class="mb-5">
        <label for="qty-input" class="block text-sm font-bold text-gray-700 mb-2">Cantidad</label>
        <div class="flex items-center gap-3">
          <button type="button" onclick="decreaseQty()"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-3 rounded-lg transition-colors">
            <i class="fas fa-minus"></i>
          </button>
          <input type="number" id="qty-input" value="1" min="1"
            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold text-lg text-center" />
          <button type="button" onclick="increaseQty()"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-3 rounded-lg transition-colors">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Stock disponible: <span id="qty-stock" class="font-bold"></span></p>
      </div>

      <div class="flex gap-3">
        <button type="button" onclick="closeQuantityModal()"
          class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg transition-colors">
          Cancelar
        </button>
        <button type="button" onclick="confirmAddToCart()"
          class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold rounded-lg shadow-lg transition-all">
          <i class="fas fa-cart-plus mr-2"></i>Agregar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal del Carrito -->
<div id="cart-modal"
  class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-[70] backdrop-blur-sm p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
    <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50">
      <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
        <i class="fas fa-shopping-cart text-green-600"></i>
        Carrito de Compras
      </h2>
      <p class="text-sm text-gray-600 mt-1">Revisa los productos antes de cobrar</p>
    </div>

    <div class="flex-1 overflow-y-auto p-6">
      <div id="cart-items" class="space-y-3">
        <!-- Los items del carrito se agregarán aquí dinámicamente -->
      </div>
      <div id="cart-empty" class="text-center py-12 hidden">
        <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-4"></i>
        <p class="text-gray-500 font-medium">El carrito está vacío</p>
      </div>
    </div>

    <div class="border-t border-gray-200 p-6 bg-gray-50">
      <div class="flex justify-between items-center mb-4">
        <span class="text-lg font-bold text-gray-700">Total:</span>
        <span id="cart-total" class="text-2xl font-bold text-green-600">$0.00</span>
      </div>
      <div class="flex gap-3">
        <button type="button" onclick="closeCartModal()"
          class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg transition-colors">
          Seguir Comprando
        </button>
        <button type="button" onclick="proceedToCheckout()" id="checkout-btn"
          class="flex-1 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold rounded-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fas fa-cash-register mr-2"></i>Cobrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Checkout (Método de Pago) -->
<div id="checkout-modal"
  class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-[80] backdrop-blur-sm p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50">
      <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
        <i class="fas fa-credit-card text-purple-600"></i>
        Método de Pago
      </h2>
    </div>

    <div class="p-6">
      <div class="mb-6 bg-green-50 p-4 rounded-xl border border-green-200">
        <div class="flex justify-between items-center">
          <span class="text-sm font-bold text-green-700">Total a Pagar:</span>
          <span id="checkout-total" class="text-2xl font-bold text-green-600">$0.00</span>
        </div>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-bold text-gray-700 mb-3">Selecciona el método de pago:</label>
        <div class="grid grid-cols-3 gap-3">
          <label
            class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all relative">
            <input type="radio" name="payment_method" value="efectivo" class="sr-only peer" checked>
            <div
              class="absolute inset-0 border-2 border-green-500 rounded-xl opacity-0 peer-checked:opacity-100 transition-opacity">
            </div>
            <i class="fas fa-money-bill-wave text-2xl mb-2 text-gray-400 peer-checked:text-green-600 z-10"></i>
            <span class="font-bold text-gray-500 peer-checked:text-green-700 text-sm z-10">Efectivo</span>
          </label>
          <label
            class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all relative">
            <input type="radio" name="payment_method" value="tarjeta" class="sr-only peer">
            <div
              class="absolute inset-0 border-2 border-green-500 rounded-xl opacity-0 peer-checked:opacity-100 transition-opacity">
            </div>
            <i class="fas fa-credit-card text-2xl mb-2 text-gray-400 peer-checked:text-green-600 z-10"></i>
            <span class="font-bold text-gray-500 peer-checked:text-green-700 text-sm z-10">Tarjeta</span>
          </label>
          <label
            class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all relative">
            <input type="radio" name="payment_method" value="transferencia" class="sr-only peer">
            <div
              class="absolute inset-0 border-2 border-green-500 rounded-xl opacity-0 peer-checked:opacity-100 transition-opacity">
            </div>
            <i class="fas fa-mobile-alt text-2xl mb-2 text-gray-400 peer-checked:text-green-600 z-10"></i>
            <span class="font-bold text-gray-500 peer-checked:text-green-700 text-sm z-10">Transf.</span>
          </label>
        </div>
      </div>

      <div class="flex gap-3">
        <button type="button" onclick="closeCheckoutModal()"
          class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg transition-colors">
          Atrás
        </button>
        <button type="button" onclick="confirmSale()"
          class="flex-1 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold rounded-lg shadow-lg transition-all">
          <i class="fas fa-check mr-2"></i>Confirmar Venta
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(-20px);
    }

    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .animate-slide-in {
    animation: slideIn 0.3s ease-out forwards;
  }
</style>

<script>
  // Carrito global con persistencia en localStorage
  let cart = JSON.parse(localStorage.getItem('hotel_cart')) || [];
  let currentProduct = null;
  const products = {{{ json products }}};

  // Función de notificación
  function mostrarNotificacion(mensaje, tipo = 'success') {
    if (typeof window.showNotification === 'function') {
      window.showNotification(mensaje, tipo);
    } else {
      alert(mensaje);
    }
  }

  // Abrir modal de cantidad
  function openQuantityModal(productId) {
    const product = products.find(p => p.id == productId);
    if (!product) return;

    // Verificar si ya está en el carrito para calcular disponible real
    const existingItem = cart.find(item => item.id == product.id);
    const cartQty = existingItem ? existingItem.cantidad : 0;
    const availableStock = product.stock - cartQty;

    if (availableStock <= 0) {
      mostrarNotificacion(`¡Ya tienes todo el stock disponible (${product.stock}) en tu carrito!`, 'warning');
      return;
    }

    currentProduct = product;
    document.getElementById('qty-product-name').textContent = product.nombre;
    document.getElementById('qty-product-price').textContent = `$${parseFloat(product.precio).toFixed(2)}`;

    // Mostrar información detallada del stock
    const stockEl = document.getElementById('qty-stock');
    if (cartQty > 0) {
      stockEl.innerHTML = `${product.stock} <span class="text-xs font-normal text-blue-600">(Tienes ${cartQty} en carrito. Disponibles: ${availableStock})</span>`;
    } else {
      stockEl.textContent = product.stock;
    }

    const input = document.getElementById('qty-input');
    input.value = 1;
    input.max = availableStock; // El máximo es lo que queda disponible, no el stock total

    document.getElementById('quantity-modal').classList.remove('hidden');
    document.getElementById('quantity-modal').classList.add('flex');
  }

  function closeQuantityModal() {
    document.getElementById('quantity-modal').classList.add('hidden');
    document.getElementById('quantity-modal').classList.remove('flex');
    currentProduct = null;
  }

  function increaseQty() {
    const input = document.getElementById('qty-input');
    const currentValue = parseInt(input.value) || 0;
    const max = parseInt(input.max);

    if (currentValue < max) {
      input.value = currentValue + 1;
    } else {
      mostrarNotificacion(`No puedes agregar más. Solo quedan ${max} disponibles.`, 'warning');

      // Animación de "shake" en el input para feedback visual
      input.classList.add('bg-red-50', 'text-red-600');
      setTimeout(() => input.classList.remove('bg-red-50', 'text-red-600'), 200);
    }
  }

  function decreaseQty() {
    const input = document.getElementById('qty-input');
    if (parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
  }

  function confirmAddToCart() {
    const input = document.getElementById('qty-input');
    const quantity = parseInt(input.value);

    if (!currentProduct || quantity <= 0) return;

    // Validación final de seguridad
    const existingItem = cart.find(item => item.id == currentProduct.id);
    const cartQty = existingItem ? existingItem.cantidad : 0;

    if (cartQty + quantity > currentProduct.stock) {
      mostrarNotificacion(`Error: La cantidad excede el stock total disponible.`, 'error');
      return;
    }

    // 1. Guardar el nombre para la notificación ANTES de limpiar currentProduct
    const savedName = currentProduct.nombre;

    if (existingItem) {
      existingItem.cantidad += quantity;
    } else {
      cart.push({
        id: currentProduct.id,
        nombre: currentProduct.nombre,
        precio: parseFloat(currentProduct.precio),
        cantidad: quantity,
        stock: currentProduct.stock
      });
    }

    // 2. CERRAR EL MODAL (esto pone currentProduct = null)
    closeQuantityModal();

    // 3. ACTUALIZAR INTERFAZ Y MOSTRAR NOTIFICACIÓN USANDO EL NOMBRE GUARDADO
    updateCart();
    mostrarNotificacion(`${quantity}x ${savedName} agregado al carrito`, 'success');
  }

  function updateCart() {
    // Guardar en localStorage
    localStorage.setItem('hotel_cart', JSON.stringify(cart));

    const cartCount = document.getElementById('cart-count');
    const cartFloatBtn = document.getElementById('cart-float-btn');
    const totalItems = cart.reduce((sum, item) => sum + item.cantidad, 0);

    cartCount.textContent = totalItems;
    if (totalItems > 0) {
      cartFloatBtn.classList.remove('hidden');
    } else {
      cartFloatBtn.classList.add('hidden');
    }
  }

  function openCartModal() {
    const cartItems = document.getElementById('cart-items');
    const cartEmpty = document.getElementById('cart-empty');
    const checkoutBtn = document.getElementById('checkout-btn');

    if (cart.length === 0) {
      cartItems.innerHTML = '';
      cartEmpty.classList.remove('hidden');
      checkoutBtn.disabled = true;
    } else {
      cartEmpty.classList.add('hidden');
      checkoutBtn.disabled = false;
      cartItems.innerHTML = cart.map((item, index) => `
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 flex items-center gap-4">
          <div class="flex-1">
            <h3 class="font-bold text-gray-900">${item.nombre}</h3>
            <p class="text-sm text-gray-600">$${item.precio.toFixed(2)} x ${item.cantidad}</p>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="decreaseCartItem(${index})" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded transition-colors">
              <i class="fas fa-minus text-xs"></i>
            </button>
            <span class="font-bold text-gray-900 w-8 text-center">${item.cantidad}</span>
            <button onclick="increaseCartItem(${index})" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded transition-colors">
              <i class="fas fa-plus text-xs"></i>
            </button>
          </div>
          <div class="text-right">
            <p class="font-bold text-green-600">$${(item.precio * item.cantidad).toFixed(2)}</p>
            <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 text-sm mt-1">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    const total = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
    document.getElementById('cart-modal').classList.remove('hidden');
    document.getElementById('cart-modal').classList.add('flex');
  }

  function closeCartModal() {
    document.getElementById('cart-modal').classList.add('hidden');
    document.getElementById('cart-modal').classList.remove('flex');
  }

  function increaseCartItem(index) {
    if (cart[index].cantidad < cart[index].stock) {
      cart[index].cantidad++;
      updateCart();
      openCartModal();
    } else {
      mostrarNotificacion('No hay más stock disponible', 'warning');
    }
  }

  function decreaseCartItem(index) {
    if (cart[index].cantidad > 1) {
      cart[index].cantidad--;
      updateCart();
      openCartModal();
    }
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    updateCart();
    openCartModal();
    mostrarNotificacion('Producto eliminado del carrito', 'info');
  }

  function proceedToCheckout() {
    const total = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    document.getElementById('checkout-total').textContent = `$${total.toFixed(2)}`;
    closeCartModal();
    document.getElementById('checkout-modal').classList.remove('hidden');
    document.getElementById('checkout-modal').classList.add('flex');
  }

  function closeCheckoutModal() {
    document.getElementById('checkout-modal').classList.add('hidden');
    document.getElementById('checkout-modal').classList.remove('flex');
    openCartModal();
  }

  async function confirmSale() {
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    const total = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);

    const saleData = {
      productos: JSON.stringify(cart.map(item => ({
        id: item.id,
        nombre: item.nombre,
        precio: item.precio,
        cantidad: item.cantidad,
        subtotal: item.precio * item.cantidad
      }))),
      total: total,
      tipo_pago: paymentMethod,
      nombre_cliente: 'Cliente de Mostrador',
      total_letras: `${total.toFixed(2)} pesos`
    };

    // Deshabilitar botón de confirmación
    const confirmBtn = document.querySelector('#checkout-modal button[onclick="confirmSale()"]');
    const originalBtnHTML = confirmBtn.innerHTML;
    confirmBtn.disabled = true;
    confirmBtn.classList.add('opacity-75', 'cursor-not-allowed');
    confirmBtn.innerHTML = `
      <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Guardando...
    `;

    try {
      const response = await fetch('/store/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(saleData)
      });
      const result = await response.json();
      if (result.success) {
        // CERRAR TODOS LOS MODALES INMEDIATAMENTE
        const checkoutModal = document.getElementById('checkout-modal');
        const cartModal = document.getElementById('cart-modal');

        if (checkoutModal) {
          checkoutModal.classList.add('hidden');
          checkoutModal.classList.remove('flex');
        }
        if (cartModal) {
          cartModal.classList.add('hidden');
          cartModal.classList.remove('flex');
        }

        // MOSTRAR NOTIFICACIÓN CON LOS MODALES YA CERRADOS
        mostrarNotificacion(`✅ Venta realizada - Total: $${total.toFixed(2)}`, 'success');

        cart = [];
        localStorage.removeItem('hotel_cart'); // LIMPIAR PERSISTENCIA
        updateCart();

        // Recargar después de un pequeño delay para que vean la notificación
        setTimeout(() => window.location.reload(), 1500);
      } else {
        mostrarNotificacion('❌ Error: ' + (result.error || 'No se pudo registrar la venta'), 'error');
        // Restaurar botón en caso de error
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        confirmBtn.innerHTML = originalBtnHTML;
      }
    } catch (error) {
      mostrarNotificacion('❌ Error de conexión al registrar la venta.', 'error');
      // Restaurar botón en caso de error
      confirmBtn.disabled = false;
      confirmBtn.classList.remove('opacity-75', 'cursor-not-allowed');
      confirmBtn.innerHTML = originalBtnHTML;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Inicializar UI con el carrito guardado
    updateCart();

    // Validación en tiempo real al escribir en el input
    const qtyInput = document.getElementById('qty-input');
    if (qtyInput) {
      qtyInput.addEventListener('input', function () {
        // Obtenemos el valor actual y el máximo permitido
        let val = parseInt(this.value);
        const max = parseInt(this.max);

        // Si no es un número válido, no hacemos nada (o podríamos poner 1)
        if (isNaN(val)) return;

        // Si intenta escribir más del máximo
        if (val > max) {
          this.value = max; // Corregimos al máximo posible
          mostrarNotificacion(`Solo puedes llevar ${max} unidades (Stock límite).`, 'warning');

          // Feedback visual
          this.classList.add('bg-red-50', 'text-red-600', 'animate-pulse');
          setTimeout(() => this.classList.remove('bg-red-50', 'text-red-600', 'animate-pulse'), 500);
        }
        // Si intenta poner menos de 1
        else if (val < 1) {
          this.value = 1;
        }
      });
    }

    // Event listeners para agregar al carrito
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const productId = button.dataset.productId;
        if (productId) openQuantityModal(productId);
      });
    });

    // Filtros
    const searchInput = document.getElementById('searchProduct');
    const categoryFilter = document.getElementById('filterCategory');
    const applyFilters = () => {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedCategory = categoryFilter.value;
      document.querySelectorAll('.product-card').forEach(card => {
        const productName = card.dataset.nombre.toLowerCase();
        const productCategory = card.dataset.categoria;
        const matchesSearch = productName.includes(searchTerm);
        const matchesCategory = !selectedCategory || productCategory === selectedCategory;
        card.style.display = (matchesSearch && matchesCategory) ? 'flex' : 'none';
      });
    };
    searchInput.addEventListener('input', applyFilters);
    categoryFilter.addEventListener('change', applyFilters);
  });
</script>
<script src="/js/ModuleStore/js/storeValidation.js"></script>
