-- Nombre de la base de datos
CREATE DATABASE IF NOT EXISTS hotel_club;

-- Si la base de datos ya existe, no se creará de nuevo
-- Usar la base de datos
USE hotel_club;


-- ======================================================
--               MODULE LOGIN                          --
-- ======================================================
-- Tabla de usuarios del hotel para la admistracion de hotel y club.

CREATE TABLE IF NOT EXISTS
users_hotel (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE, -- Nombre de usuario único
  password VARCHAR(255) NOT NULL, -- Contraseña cifrada
  role ENUM ('Administrador', 'Usuario') NOT NULL -- Rol del usuario
);


CREATE TABLE IF NOT EXISTS   -- Tabla para almacenar tokens de recuperación de contraseña
password_resets (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL, -- ID del usuario que solicita la recuperación
  token VARCHAR(255) NOT NULL UNIQUE, -- Token único para la recuperación
  expires_at DATETIME NOT NULL, -- Fecha y hora de expiración del token
  FOREIGN KEY (user_id) REFERENCES users_hotel (id) ON DELETE CASCADE
);

-- =====================================================
-- MÓDULO DE HABITACIONES
-- =====================================================

-- 1) Tabla de Habitaciones
CREATE TABLE IF NOT EXISTS habitaciones (
  id INT AUTO_INCREMENT PRIMARY KEY,
  numero VARCHAR(10) NOT NULL UNIQUE,
  tipo ENUM('sencilla', 'suite') NOT NULL,
  estado ENUM('disponible', 'ocupado', 'limpieza') DEFAULT 'disponible'
);

-- Insertar habitaciones fijas (idempotente)
INSERT IGNORE INTO habitaciones (numero, tipo) VALUES
  ('101', 'sencilla'),
  ('102', 'sencilla'),
  ('103', 'sencilla'),
  ('104', 'sencilla'),
  ('106', 'sencilla'),
  ('107', 'sencilla'),
  ('108', 'sencilla'),
  ('109', 'sencilla'),
  ('105', 'suite'),
  ('110', 'suite');

-- 2) Tabla de Precios
-- Precio definido por mes y tipo de habitación
CREATE TABLE IF NOT EXISTS precios (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tipo_habitacion ENUM('sencilla', 'suite') NOT NULL,
  mes INT NOT NULL CHECK (mes BETWEEN 1 AND 12),
  monto DECIMAL(10, 2) NOT NULL,
  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (tipo_habitacion, mes)
);

-- Insertar precios (idempotente)
INSERT IGNORE INTO precios (tipo_habitacion, mes, monto) VALUES
  ('sencilla', 1, 100.00),
  ('sencilla', 2, 100.00),
  ('sencilla', 3, 120.00),
  ('sencilla', 4, 120.00),
  ('sencilla', 5, 150.00),
  ('sencilla', 6, 150.00),
  ('sencilla', 7, 200.00),
  ('sencilla', 8, 200.00),
  ('sencilla', 9, 150.00),
  ('sencilla', 10, 150.00),
  ('sencilla', 11, 120.00),
  ('sencilla', 12, 120.00),
  ('suite', 1, 200.00),
  ('suite', 2, 200.00),
  ('suite', 3, 250.00),
  ('suite', 4, 250.00),
  ('suite', 5, 300.00),
  ('suite', 6, 300.00),
  ('suite', 7, 400.00),
  ('suite', 8, 400.00),
  ('suite', 9, 300.00),
  ('suite', 10, 300.00),
  ('suite', 11, 250.00),
  ('suite', 12, 250.00);

-- Medios de mensajes (correo/teléfono)
CREATE TABLE IF NOT EXISTS medios_mensajes (
  id_medio_mensaje INT AUTO_INCREMENT PRIMARY KEY,
  correo_cliente VARCHAR(100) NOT NULL,
  telefono_cliente VARCHAR(20) NOT NULL
);

-- 3) Tabla de Reservaciones
-- NOTA: DATETIME guarda fecha y hora (12:00 PM)
CREATE TABLE IF NOT EXISTS reservaciones (
  id INT AUTO_INCREMENT PRIMARY KEY,
  habitacion_id INT NOT NULL,
  usuario_id INT NOT NULL,
  id_medio_mensaje INT NOT NULL,
  nombre_cliente VARCHAR(100) NOT NULL,
  fecha_reserva DATETIME NOT NULL,
  fecha_ingreso DATETIME NOT NULL,
  fecha_salida DATETIME NOT NULL,
  monto DECIMAL(10, 2) NOT NULL,
  monto_letras VARCHAR(255) NOT NULL,
  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (habitacion_id) REFERENCES habitaciones (id),
  FOREIGN KEY (usuario_id) REFERENCES users_hotel (id),
  FOREIGN KEY (id_medio_mensaje) REFERENCES medios_mensajes (id_medio_mensaje)
);

-- 4) Tabla de Rentas
-- NOTA: DATETIME guarda fecha y hora (12:00 PM)
CREATE TABLE IF NOT EXISTS rentas (
  id INT AUTO_INCREMENT PRIMARY KEY,
  habitacion_id INT NOT NULL,
  usuario_id INT NOT NULL,
  id_medio_mensaje INT NOT NULL,
  nombre_cliente VARCHAR(100) NOT NULL,
  fecha_ingreso DATETIME NOT NULL,
  fecha_salida DATETIME NOT NULL,
  tipo_pago ENUM('tarjeta', 'transferencia', 'efectivo') NOT NULL,
  monto DECIMAL(10, 2) NOT NULL,
  monto_letras VARCHAR(255) NOT NULL,
  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (habitacion_id) REFERENCES habitaciones (id),
  FOREIGN KEY (usuario_id) REFERENCES users_hotel (id),
  FOREIGN KEY (id_medio_mensaje) REFERENCES medios_mensajes (id_medio_mensaje)
);

-- ===========================================
-- Tabla: pdf_registry
-- Registro de PDFs generados (rentas/reservaciones)
-- ===========================================
CREATE TABLE IF NOT EXISTS pdf_registry (
  id INT AUTO_INCREMENT PRIMARY KEY,
  rent_id INT NOT NULL,
  client_name VARCHAR(255) NOT NULL,
  phone VARCHAR(20) NOT NULL,
  room_number VARCHAR(10) NOT NULL,
  file_name VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size BIGINT DEFAULT 0,
  qr_data TEXT,
  generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  sent_whatsapp BOOLEAN DEFAULT FALSE,
  sent_email BOOLEAN DEFAULT FALSE,
  status ENUM('generated', 'sent', 'error') DEFAULT 'generated',
  INDEX idx_rent_id (rent_id),
  INDEX idx_client_name (client_name),
  INDEX idx_generated_at (generated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


-- =====================================================
-- EJEMPLO DE CONSULTA PARA EL CALENDARIO
-- Mostrar habitaciones ocupadas en los próximos días
-- =====================================================

SELECT
  h.numero,
  h.tipo,
  r.fecha_ingreso,
  r.fecha_salida,
  r.nombre_cliente
FROM
  reservaciones r
  INNER JOIN habitaciones h ON r.habitacion_id = h.id
WHERE
  r.fecha_salida >= CURDATE ()
ORDER BY
  r.fecha_ingreso;


-- =====================================================
-- GENERACIÓN DE REPORTES
-- =====================================================

-- Reporte de ingresos por rentas diarias
SELECT
    DATE(fecha_ingreso) AS dia,
    COUNT(id) AS total_rentas,
    SUM(monto) AS total_ingresos
FROM rentas
GROUP BY DATE(fecha_ingreso)
ORDER BY DATE(fecha_ingreso);


-- Reporte de ingresos por rentas en la última semana
SELECT
    COUNT(id) AS total_rentas,
    SUM(monto) AS total_ingresos
FROM rentas
WHERE fecha_ingreso BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE();

-- Reporte de ingresos por rentas en los últimos 15 días
SELECT
    COUNT(id) AS total_rentas,
    SUM(monto) AS total_ingresos
FROM rentas
WHERE fecha_ingreso BETWEEN CURDATE() - INTERVAL 15 DAY AND CURDATE();

-- Reporte de ingresos por rentas en el mes actual
SELECT
    COUNT(id) AS total_rentas,
    SUM(monto) AS total_ingresos
FROM rentas
WHERE MONTH(fecha_ingreso) = MONTH(CURDATE())
  AND YEAR(fecha_ingreso) = YEAR(CURDATE());




-- =====================================================
-- MÓDULO DE MEMBRESÍAS
-- =====================================================
--Tabla de clientes
CREATE TABLE clientes (
    id_cliente bigint unsigned NOT NULL AUTO_INCREMENT,
    nombre_completo varchar(150) NOT NULL,
    telefono varchar(20) DEFAULT NULL,
    correo varchar(100) DEFAULT NULL,
    fecha_registro timestamp NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id_cliente),
    UNIQUE KEY id_cliente (id_cliente)
) ENGINE = InnoDB AUTO_INCREMENT = 115 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci



--Tabla de integrantes_membresia
CREATE TABLE integrantes_membresia (
    id_integrante bigint unsigned NOT NULL AUTO_INCREMENT,
    id_activa int NOT NULL,
    nombre_completo varchar(150) NOT NULL,
    fecha_registro timestamp NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id_integrante),
    UNIQUE KEY id_integrante (id_integrante)
) ENGINE = InnoDB AUTO_INCREMENT = 10 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci

--Tabla de membresias
CREATE TABLE membresias (
    id_membresia bigint unsigned NOT NULL AUTO_INCREMENT,
    id_cliente int NOT NULL,
    id_tipo_membresia int NOT NULL,
    fecha_inicio date NOT NULL,
    fecha_fin date NOT NULL,
    fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id_membresia),
    UNIQUE KEY id_membresia (id_membresia)
) ENGINE = InnoDB AUTO_INCREMENT = 43 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci


--Tabla de membresias_activas
CREATE TABLE membresias_activas (
    id_activa bigint unsigned NOT NULL AUTO_INCREMENT,
    id_cliente int NOT NULL,
    id_membresia int NOT NULL,
    fecha_inicio date NOT NULL,
    fecha_fin date NOT NULL,
    precio_final decimal(10, 2) NOT NULL,
    qr_path varchar(255) DEFAULT NULL,
    estado varchar(20) DEFAULT 'Activa',
    PRIMARY KEY (id_activa),
    UNIQUE KEY id_activa (id_activa),
    KEY idx_qr_path (qr_path),
    CONSTRAINT membresias_activas_chk_1 CHECK ((precio_final > 0)),
    CONSTRAINT membresias_activas_chk_2 CHECK (
        (
            estado in (
                _utf8mb4 'Activa',
                _utf8mb4 'Vencida',
                _utf8mb4 'Cancelada'
            )
        )
    ),
    CONSTRAINT membresias_activas_chk_3 CHECK (
        (fecha_fin > fecha_inicio)
    )
) ENGINE = InnoDB AUTO_INCREMENT = 43 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci


--Tabla de metodos_pago
CREATE TABLE metodos_pago (
    id_metodo_pago bigint unsigned NOT NULL AUTO_INCREMENT,
    nombre varchar(50) NOT NULL,
    PRIMARY KEY (id_metodo_pago),
    UNIQUE KEY id_metodo_pago (id_metodo_pago),
    UNIQUE KEY nombre (nombre)
) ENGINE = InnoDB AUTO_INCREMENT = 5 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci


--Tabla de pagos
CREATE TABLE pagos (
    id_pago bigint unsigned NOT NULL AUTO_INCREMENT,
    id_activa int NOT NULL,
    id_metodo_pago int NOT NULL,
    monto decimal(10, 2) NOT NULL,
    fecha_pago timestamp NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id_pago),
    UNIQUE KEY id_pago (id_pago),
    CONSTRAINT pagos_chk_1 CHECK ((monto > 0))
) ENGINE = InnoDB AUTO_INCREMENT = 15 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci


--Tabla de tipos_membresia
CREATE TABLE tipos_membresia (
    id_tipo_membresia bigint unsigned NOT NULL AUTO_INCREMENT,
    nombre varchar(50) NOT NULL,
    descripcion text,
    max_integrantes int DEFAULT '1',
    precio decimal(10, 2) NOT NULL,
    PRIMARY KEY (id_tipo_membresia),
    UNIQUE KEY id_tipo_membresia (id_tipo_membresia),
    UNIQUE KEY nombre (nombre),
    CONSTRAINT tipos_membresia_chk_1 CHECK ((max_integrantes >= 1))
) ENGINE = InnoDB AUTO_INCREMENT = 6 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci

-- Insertar métodos de pago básicos
INSERT INTO metodos_pago (nombre) VALUES
('Efectivo'),
('Tarjeta de crédito'),
('Tarjeta de débito'),
('Transferencia bancaria');
ON CONFLICT (nombre) DO NOTHING;

-- Insertar tipos de membresía básicos (si no existen)
INSERT INTO tipos_membresia (nombre, descripcion, max_integrantes, precio) VALUES
('Individual GYM', 'Membresía para una persona', 1, 500.00),
('Individual Alberca', 'Membresía para una persona', 1, 500.00),
('Individual General', 'Membresía para una persona', 1, 500.00),
('Familiar', 'Membresía para toda la familia', 4, 1200.00);
ON CONFLICT (nombre) DO NOTHING;
